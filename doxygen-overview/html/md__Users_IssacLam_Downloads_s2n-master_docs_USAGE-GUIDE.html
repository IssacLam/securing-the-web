<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>s2n-doxygen-full: Using s2n</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">s2n-doxygen-full
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__Users_IssacLam_Downloads_s2n-master_docs_USAGE-GUIDE.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using s2n </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>s2n is a C library, and is built using Make. To clone the latest copy of s2n from git use:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;git clone https://github.com/awslabs/s2n.git</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd s2n</div></div><!-- fragment --><h2>Building s2n with existing libcrypto</h2>
<p>To build s2n with an existing libcrypto installation, store its root folder in the <code>LIBCRYPTO_ROOT</code> environment variable. </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# /usr/local/ssl/lib should contain libcrypto.a</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;LIBCRYPTO_ROOT=/usr/local/ssl make</div></div><!-- fragment --><h2>Building s2n with LibreSSL</h2>
<p>To build s2n with LibreSSL, do the following:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# We keep the build artifacts in the -build directory</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd libcrypto-build</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;# Download the latest version of LibreSSL</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;curl -O http://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-x.y.z.tar.gz</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;tar -xzvf libressl-x.y.z.tar.gz</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;# Build LibreSSL&#39;s libcrypto</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;cd libressl-x.y.z</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;./configure --prefix=`pwd`/../../libcrypto-root/</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;make CFLAGS=-fPIC install</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;# Make to the main s2n directory</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;cd ../../</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;# Build s2n</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;make</div></div><!-- fragment --><p>once built, static and dynamic libraries for s2n will be available in the lib/ directory.</p>
<h2>Building s2n with BoringSSL</h2>
<p>To build s2n with BoringSSL, you must check out a copy of the BoringSSL directly via git. This procedure has been tested with fb68d6c901b98ffe15b8890d00bc819bf44c5f01 of BoringSSL.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# We keep the build artifacts in the -build directory</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd libcrypto-build</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;# Clone BoringSSL</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;git clone https://boringssl.googlesource.com/boringssl</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;# Build BoringSSL</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;cd boringssl</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;mkdir build</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;cd build</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;cmake -DCMAKE_C_FLAGS=&quot;-fPIC&quot; ../</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;make</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;# Copy the built library and includes</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;mkdir ../../../libcrypto-root/lib/</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;cp crypto/libcrypto.a ../../../libcrypto-root/lib/</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;cp -r ../include/ ../../../libcrypto-root/include</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;# Build s2n</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;cd ../../../</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;make</div></div><!-- fragment --><p>once built, static and dynamic libraries for s2n will be available in the lib/ directory.</p>
<h2>Building s2n with OpenSSL-1.0.2</h2>
<p>To build s2n with OpenSSL-1.0.2, do the following:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# We keep the build artifacts in the -build directory</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd libcrypto-build</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;# Download the latest version of OpenSSL</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;curl -LO https://www.openssl.org/source/openssl-1.0.2-latest.tar.gz</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;tar -xzvf openssl-1.0.2-latest.tar.gz</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;# Build openssl&#39; libcrypto  (NOTE: check directory name 1.0.2-latest unpacked as)</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;cd openssl-1.0.2d</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;./config -fPIC no-shared no-libunbound no-gmp no-jpake no-krb5              \</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;         no-md2 no-rc5 no-rfc3779 no-sctp no-ssl-trace no-store no-zlib     \</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;         no-hw no-mdc2 no-seed no-idea enable-ec-nist_64_gcc_128 no-camellia\</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;         no-bf no-ripemd no-dsa no-ssl2 no-ssl3 no-capieng                  \</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;         -DSSL_FORBID_ENULL -DOPENSSL_NO_DTLS1 -DOPENSSL_NO_HEARTBEATS      \</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;         --prefix=`pwd`/../../libcrypto-root/</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;make depend</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;make</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;make install</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;# Make to the main s2n directory</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;cd ../../</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;# Build s2n</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;make</div></div><!-- fragment --><p><b>Mac Users:</b> please replace "./config" with "./Configure darwin64-x86_64-cc".</p>
<p>once built, static and dynamic libraries for s2n will be available in the lib/ directory.</p>
<h2>mlock() and system limits</h2>
<p>Internally s2n uses mlock() to prevent memory from being swapped to disk. The s2n build tests may fail in some environments where the default limit on locked memory is too low. To check this limit, run:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;ulimit -l</div></div><!-- fragment --><p>to raise the limit, consult the documentation for your platform.</p>
<h3>Disabling mlock()</h3>
<p>To disable s2n's mlock behavior, run your application with the <code>S2N_DONT_MLOCK</code> environment variable set. s2n also reads this for unit tests. Try <code>S2N_DONT_MLOCK=1 make</code> if you're having mlock failures during unit tests.</p>
<h2>client mode</h2>
<p>At this time s2n does not perform certificate validation and client mode is disabled as a precaution. To enable client mode for testing and development, set the <b>S2N_ENABLE_CLIENT_MODE</b> environment variable.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;export S2N_ENABLE_CLIENT_MODE=1</div></div><!-- fragment --><h1>s2n API</h1>
<p>The API exposed by s2n is the set of functions and declarations that are in the "s2n.h" header file. Any functions and declarations that are in the "s2n.h" file are intended to be stable (API and ABI) within major version numbers of s2n releases. Other functions and structures used in s2n internally can not be considered stable and their parameters, names, and sizes may change.</p>
<p>At this time (Summer 2015), there has been no numbered release of s2n and all APIs are subject to change based on the feedback and preferences of early adopters.</p>
<h2>Preprocessor macros</h2>
<p>s2n defines five preprocessor macros that are used to determine what version of SSL/TLS is in use on a connection.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define S2N_SSLv2 20</span></div><div class="line"><span class="preprocessor">#define S2N_SSLv3 30</span></div><div class="line"><span class="preprocessor">#define S2N_TLS10 31</span></div><div class="line"><span class="preprocessor">#define S2N_TLS11 32</span></div><div class="line"><span class="preprocessor">#define S2N_TLS12 33</span></div></div><!-- fragment --><p>These correspond to SSL2.0, SSL3.0, TLS1.0, TLS1.1 and TLS1.2 respectively. Note that s2n does not support SSL2.0 for sending and receiving encrypted data, but does accept SSL2.0 hello messages.</p>
<h2>Enums</h2>
<p>s2n defines four enum types:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> { <a class="code" href="s2n_8h.html#a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52">S2N_SERVER</a>, <a class="code" href="s2n_8h.html#a77a64e3b657f90d221c5faf99c643cdbac93ba9ce574a0b5893fe2a5960e1785d">S2N_CLIENT</a> } <a class="code" href="s2n_8h.html#a77a64e3b657f90d221c5faf99c643cdb">s2n_mode</a>;</div></div><!-- fragment --><p><b>s2n_mode</b> is used to declare connections as server or client type, respectively. At this time, s2n does not function as a client and only S2N_SERVER should be used.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> { <a class="code" href="s2n_8h.html#af70ca0b089daa98cd79a424d3f6af15da7afdc9e789b567fe89c7142f34ec3ebd">S2N_NOT_BLOCKED</a>, <a class="code" href="s2n_8h.html#af70ca0b089daa98cd79a424d3f6af15daf76a7c83e9548139b7b8d50bdd5ff323">S2N_BLOCKED_ON_READ</a>, <a class="code" href="s2n_8h.html#af70ca0b089daa98cd79a424d3f6af15daefb6db9aaec431d69fc4c1249bc432e3">S2N_BLOCKED_ON_WRITE</a> } <a class="code" href="s2n_8h.html#af70ca0b089daa98cd79a424d3f6af15d">s2n_blocked_status</a>;</div></div><!-- fragment --><p><b>s2n_blocked_status</b> is used in non-blocking mode to indicate in which direction s2n became blocked on I/O before it returned control to the caller. This allows an application to avoid retrying s2n operations until I/O is possible in that direction.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> { <a class="code" href="s2n_8h.html#a364ad496c9dd42fd3117a2f9d3289e62a090459f0733b199be908d881d7db871f">S2N_BUILT_IN_BLINDING</a>, <a class="code" href="s2n_8h.html#a364ad496c9dd42fd3117a2f9d3289e62a1b0ee228485be6bb2d6e2129827d51d2">S2N_SELF_SERVICE_BLINDING</a> } <a class="code" href="s2n_8h.html#a364ad496c9dd42fd3117a2f9d3289e62">s2n_blinding</a>;</div></div><!-- fragment --><p><b>s2n_blinding</b> is used to opt-out of s2n's built-in blinding. Blinding is a mitigation against timing side-channels which in some cases can leak information about encrypted data. By default s2n will cause a thread to sleep between 1ms and 10 seconds whenever tampering is detected.</p>
<p>Setting the <b>S2N_SELF_SERVICE_BLINDING</b> option with <b>s2n_connection_set_blinding</b> turns off this behavior. This is useful for applications that are handling many connections in a single thread. In that case, if <a class="el" href="s2n_8h.html#afede11e597a4db3024ec2b68733a643d">s2n_recv()</a> or <a class="el" href="s2n_8h.html#a309d98d4c1adfd10c5dd62192f4c1051">s2n_negotiate()</a> return an error, self-service applications should call <b>s2n_connection_get_delay</b> and pause activity on the connection for the specified number of nanoseconds before calling close() or shutdown().</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> { <a class="code" href="s2n_8h.html#a7d38e45340d223d0100a2d4bc0526635aea0f05b257857adc1282f77c5414e35a">S2N_STATUS_REQUEST_NONE</a>, <a class="code" href="s2n_8h.html#a7d38e45340d223d0100a2d4bc0526635a3e83f0e90eef54adc21b3d97a9a0d9b8">S2N_STATUS_REQUEST_OCSP</a> } <a class="code" href="s2n_8h.html#a7d38e45340d223d0100a2d4bc0526635">s2n_status_request_type</a>;</div></div><!-- fragment --><p><b>s2n_status_request_type</b> is used to define the type, if any, of certificate status request an S2N_CLIENT should make during the handshake. The only supported status request type is OCSP, <b>S2N_STATUS_REQUEST_OCSP</b>.</p>
<h2>Opaque structures</h2>
<p>s2n defines two opaque structures that are used for managed objects. Because these structures are opaque, they can only be safely referenced indirectly through pointers and their sizes may change with future versions of s2n.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="structs2n__config.html">s2n_config</a>;</div><div class="line"><span class="keyword">struct </span><a class="code" href="structs2n__connection.html">s2n_connection</a>;</div></div><!-- fragment --><p><b><a class="el" href="structs2n__config.html">s2n_config</a></b> structures are a configuration object, used by servers for holding cryptographic certificates, keys and preferences. <b><a class="el" href="structs2n__connection.html">s2n_connection</a></b> structures are used to track each connection.</p>
<h2>Error handling</h2>
<p>s2n functions that return 'int' return 0 to indicate success and -1 to indicate failure. s2n functions that return pointer types return NULL in the case of failure. When an s2n function returns a failure, s2n_errno will be set to a value corresponding to the error. This error value can be translated into a string explaining the error in English by calling s2n_strerror(s2n_errno, "EN");</p>
<p>Example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;if (s2n_config_set_cipher_preferences(config, prefs) &lt; 0) {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    printf(&quot;Setting cipher prefs failed! %s&quot;, (s2n_strerror(s2n_errno, &quot;EN&quot;));</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    return -1;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;}</div></div><!-- fragment --><h3>Error categories</h3>
<p>s2n organizes errors into different "types" to allow applications to do logic on error values without catching all possibilities. Applications using non-blocking I/O should check error type to determine if the I/O operation failed because it would block or for some other error. To retrieve the type for a given error use <code><a class="el" href="s2n_8h.html#a526856aac3b44999c3f716a3df648da1">s2n_error_get_type()</a></code>. Applications should perform any error handling logic using these high level types:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;S2N_ERR_T_OK=0, /* No error */</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;S2N_ERR_T_IO, /* Underlying I/O operation failed, check system errno */</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;S2N_ERR_T_CLOSED, /* EOF */</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;S2N_ERR_T_BLOCKED, /* Underlying I/O operation would block */</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;S2N_ERR_T_ALERT, /* Incoming Alert */</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;S2N_ERR_T_PROTO, /* Failure in some part of the TLS protocol. Ex: CBC verification failure */</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;S2N_ERR_T_INTERNAL, /* Error internal to s2n. A precondition could have failed. */</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;S2N_ERR_T_USAGE /* User input error. Ex: Providing an invalid cipher preference version */</div></div><!-- fragment --><p>Here's an example that handles errors based on type:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;if (s2n_recv(conn, &amp;blocked) &lt; 0) {</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;    switch(s2n_error_get_type(s2n_errno)) {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;        case S2N_ERR_T_BLOCKED:</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;            /* Blocked, come back later */</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;            return -1;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;        case S2N_ERR_T_CLOSED:</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;            return 0;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        case S2N_ERR_T_IO:</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;            handle_io_err();</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;            return -1;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;        case S2N_ERR_T_PROTO:</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;            handle_proto_err();</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;            return -1;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        case S2N_ERR_T_ALERT:</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;            log_alert(s2n_connection_get_alert(conn));</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;            return -1;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        /* Everything else */</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        default:</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;            log_other_error();</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;            return -1;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    }</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;}</div></div><!-- fragment --><h2>Initialization and teardown</h2>
<h3>s2n_init</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#abc620f8194383c6fcddd911edcf7d692">s2n_init</a>();</div></div><!-- fragment --><p><b>s2n_init</b> initializes the s2n library and should be called once in your application, before any other s2n functions are called. Failure to call <a class="el" href="s2n_8h.html#abc620f8194383c6fcddd911edcf7d692">s2n_init()</a> will result in errors from other s2n functions.</p>
<h3>s2n_cleanup</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a907fdf445e5fb1752f1b18f0ddf935b3">s2n_cleanup</a>();</div></div><!-- fragment --><p><b>s2n_cleanup</b> cleans up any internal resources used by s2n. This function should be called from each thread or process that is created subsequent to calling <b>s2n_init</b> when that thread or process is done calling other s2n functions.</p>
<h2>Configuration-oriented functions</h2>
<h3>s2n_config_new</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="structs2n__config.html">s2n_config</a> * <a class="code" href="s2n_8h.html#a29ce06d12862218a283abdac554c8e19">s2n_config_new</a>();</div></div><!-- fragment --><p><b>s2n_config_new</b> returns a new configuration object suitable for associating certs and keys. This object can (and should) be associated with many connection objects.</p>
<h3>s2n_config_free</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span>int <a class="code" href="s2n_8h.html#a25b7d82e94f572b657be3936196222c3">s2n_config_free</a>(struct <a class="code" href="structs2n__config.html">s2n_config</a> *<a class="code" href="apps_8h.html#a67aa6ff0076e9d4fb2b5ad9e6fcb4d89">config</a>);</div></div><!-- fragment --><p><b>s2n_config_free</b> frees the memory associated with an <b><a class="el" href="structs2n__config.html">s2n_config</a></b> object.</p>
<h3>s2n_config_set_cipher_preferences</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a21b09fcd09e2d33e8ed9389a109f2ab2">s2n_config_set_cipher_preferences</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config,</div><div class="line">                                      <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="s2n__config_8c.html#aa31f487a99743d24af9076a3e11e5425">version</a>);</div></div><!-- fragment --><p><b>s2n_config_set_cipher_preferences</b> sets the ciphersuite and protocol versions. The currently supported versions are;</p>
<table class="doxtable">
<tr>
<th>version </th><th>SSLv3 </th><th>TLS1.0 </th><th>TLS1.1 </th><th>TLS1.2 </th><th>AES-CBC </th><th>AES-GCM </th><th>3DES </th><th>RC4 </th><th>DHE </th><th>ECDHE  </th></tr>
<tr>
<td>"default" </td><td></td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td></td><td></td><td>X </td></tr>
<tr>
<td>"20160411" </td><td></td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td></td><td></td><td>X </td></tr>
<tr>
<td>"20150306" </td><td></td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td></td><td></td><td>X </td></tr>
<tr>
<td>"20150214" </td><td></td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td></td><td>X </td><td></td></tr>
<tr>
<td>"20150202" </td><td></td><td>X </td><td>X </td><td>X </td><td>X </td><td></td><td>X </td><td></td><td>X </td><td></td></tr>
<tr>
<td>"20141001" </td><td></td><td>X </td><td>X </td><td>X </td><td>X </td><td></td><td>X </td><td>X </td><td>X </td><td></td></tr>
<tr>
<td>"20140601" </td><td>X </td><td>X </td><td>X </td><td>X </td><td>X </td><td></td><td>X </td><td>X </td><td>X </td><td></td></tr>
</table>
<p>The "default" version is special in that it will be updated with future s2n changes and ciphersuites and protocol versions may be added and removed, or their internal order of preference might change. Numbered versions are fixed and will never change.</p>
<p>"20160411" follows the same general preference order as "default". The main difference is it has a CBC cipher suite at the top. This is to accomodate certain Java clients that have poor GCM implementations. Users of s2n who have found GCM to be hurting performance for their clients should consider this version.</p>
<p>s2n does not expose an API to control the order of preference for each ciphersuite or protocol version. s2n follows the following order:</p>
<ol type="1">
<li>Always prefer the highest protocol version supported</li>
<li>Always use forward secrecy where possible. Prefer ECDHE over DHE.</li>
<li>Prefer encryption ciphers in the following order: AES128, 3DES, AES256, RC4.</li>
<li>Prefer record authentication modes in the following order: GCM, SHA256, SHA1, MD5.</li>
</ol>
<h3>s2n_config_add_cert_chain_and_key</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a315153a7f97b2568970c19f7bf1d372e">s2n_config_add_cert_chain_and_key</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config, </div><div class="line">                                      <span class="keywordtype">char</span> *cert_chain_pem, </div><div class="line">                                      <span class="keywordtype">char</span> *private_key_pem);</div></div><!-- fragment --><p><b>s2n_config_add_cert_chain_and_key</b> associates a certificate chain and a private key, with an <b><a class="el" href="structs2n__config.html">s2n_config</a></b> object. At present, only one certificate-chain/key pair may be associated with a config.</p>
<p><b>cert_chain_pem</b> should be a PEM encoded certificate chain, with the first certificate in the chain being your servers certificate. <b>private_key_pem</b> should be a PEM encoded private key corresponding to the server certificate.</p>
<h3>s2n_config_add_cert_chain_and_key_with_status</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a0275e457e9c62cf1d5b9a1126e853003">s2n_config_add_cert_chain_and_key_with_status</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config, </div><div class="line">                                                  <span class="keywordtype">char</span> *cert_chain_pem, </div><div class="line">                                                  <span class="keywordtype">char</span> *private_key_pem,</div><div class="line">                                                  <span class="keyword">const</span> uint8_t *status,</div><div class="line">                                                  uint32_t <a class="code" href="crypto_2asn1_2asn1_8h.html#a5a2d57a92488e64c730cabc247c9d5b5">length</a>);</div></div><!-- fragment --><p><b>s2n_config_add_cert_chain_and_key_with_status</b> performs the same function as s2n_config_add_cert_chain_and_key, and associates an OCSP status response with the server certificate. If a client requests the OCSP status of the server certificate, this is the response used in the CertificateStatus handshake message.</p>
<h3>s2n_config_add_dhparams</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a82513564c95dc7a4174c3d04eb043564">s2n_config_add_dhparams</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config, </div><div class="line">                            <span class="keywordtype">char</span> *dhparams_pem);</div></div><!-- fragment --><p><b>s2n_config_add_dhparams</b> associates a set of Diffie-Hellman parameters with an <b><a class="el" href="structs2n__config.html">s2n_config</a></b> object. <b>dhparams_pem</b> should be PEM encoded DH parameters.</p>
<h3>s2n_config_set_protocol_preferences</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a9f5f2fca97444f9c039a3681c2351fb0">s2n_config_set_protocol_preferences</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config,</div><div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">char</span> **protocols,</div><div class="line">                                        <span class="keywordtype">int</span> protocol_count);</div></div><!-- fragment --><p><b>s2n_config_set_protocol_preferences</b> sets the application protocol preferences on an <b><a class="el" href="structs2n__config.html">s2n_config</a></b> object. <b>protocols</b> is a list in order of preference, with most preferred protocol first, and of length <b>protocol_count</b>. When acting as an <b>S2N_CLIENT</b> the protocol list is included in the Client Hello message as the ALPN extension. As an <b>S2N_SERVER</b>, the list is used to negotiate a mutual application protocol with the client.</p>
<h3>s2n_config_set_status_request_type</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#ae98f2b06b3311e7e845e938392d3505d">s2n_config_set_status_request_type</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config, s2n_status_request_type <a class="code" href="crypto_2x509_2x509_8h.html#ab512b8f495325c7ea0f5a5a5d3f938eb">type</a>);</div></div><!-- fragment --><p><b>s2n_config_set_status_request_type</b> Sets up an S2N_CLIENT to request the server certificate status during an SSL handshake. If set to S2N_STATUS_REQUEST_NONE, no status request is made.</p>
<h3>s2n_config_set_nanoseconds_since_epoch_callback</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a55f4687b7def930a7ac41335d35d72ef">s2n_config_set_nanoseconds_since_epoch_callback</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config, <span class="keywordtype">int</span> (*nanoseconds_since_epoch)(<span class="keywordtype">void</span> *, uint64_t *), <span class="keywordtype">void</span> * data);</div></div><!-- fragment --><p><b>s2n_config_set_nanoseconds_since_epoch_callback</b> allows the caller to set a callback function that will be used to get the time. The callback function takes two arguments; a pointer to abitrary data for use within the callback, and a pointer to a 64 bit unsigned integer. The first pointer will be set to the value of <b>data</b> which supplied by the caller when setting the callback. The integer pointed to by the second pointer should be set to the number of nanoseconds since the Unix epoch (Midnight, January 1st, 1970). The function should return 0 on success and -1 on error. The function is also required to implement a monotonic time source; the number of nanoseconds returned should never decrease between calls.</p>
<h2>Session Caching related calls</h2>
<p>s2n includes support for resuming from cached SSL/TLS session, provided the caller sets (and implements) three callback functions.</p>
<h3>s2n_config_set_cache_store_callback</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a2b4ec043b39d8a0e3f4f5113e941c338">s2n_config_set_cache_store_callback</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config, <span class="keywordtype">int</span> (*<a class="code" href="s2nd_8c.html#a9415451f8ae94353430b3e0890ad6196">cache_store</a>)(<span class="keywordtype">void</span> *, uint64_t ttl_in_seconds, <span class="keyword">const</span> <span class="keywordtype">void</span> *key, uint64_t key_size, <span class="keyword">const</span> <span class="keywordtype">void</span> *value, uint64_t value_size), <span class="keywordtype">void</span> *data);</div></div><!-- fragment --><p><b>s2n_config_set_cache_store_callback</b> allows the caller to set a callback function that will be used to store SSL session data in a cache. The callback function takes six arguments: a pointer to abitrary data for use within the callback, a 64-bit unsigned integer specifying the number of seconds the session data may be stored for, a pointer to a key which can be used to retrieve the cached entry, a 64 bit unsigned integer specifying the size of this key, a pointer to a value which should be stored, and a 64 bit unsigned integer specified the size of this value.</p>
<h3>s2n_config_set_cache_retrieve_callback</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#ab1cd3ada52e3854db427d219a7183de2">s2n_config_set_cache_retrieve_callback</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config, <span class="keywordtype">int</span> (*<a class="code" href="s2nd_8c.html#a0153b562f602987e5668497ccb285868">cache_retrieve</a>)(<span class="keywordtype">void</span> *, <span class="keyword">const</span> <span class="keywordtype">void</span> *key, uint64_t key_size, <span class="keywordtype">void</span> *value, uint64_t *value_size), <span class="keywordtype">void</span> *data)</div></div><!-- fragment --><p><b>s2n_config_set_cache_retrieve_callback</b> allows the caller to set a callback function that will be used to retrieve SSL session data from a cache. The callback function takes five arguments: a pointer to abitrary data for use within the callback, a pointer to a key which can be used to retrieve the cached entry, a 64 bit unsigned integer specifying the size of this key, a pointer to a memory location where the value should be stored, and a pointer to a 64 bit unsigned integer specifing the size of this value. Initially *value_size will be set to the amount of space allocated for the value, the callback should set *value_size to the actual size of the data returned. If there is insufficient space, -1 should be returned.</p>
<h3>s2n_config_set_cache_delete_callback</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a5a13d9dc1fefcdd6c08c329e47f84e9e">s2n_config_set_cache_delete_callback</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config, <span class="keywordtype">int</span> (*<a class="code" href="s2nd_8c.html#a82dfd7cd8c27b3f6e78bc51538e81dce">cache_delete</a>))(<span class="keywordtype">void</span> *, <span class="keyword">const</span> <span class="keywordtype">void</span> *key, uint64_t key_size), <span class="keywordtype">void</span> *data);</div></div><!-- fragment --><p><b>s2n_config_set_cache_delete_callback</b> allows the caller to set a callback function that will be used to delete SSL session data from a cache. The callback function takes three arguments: a pointer to abitrary data for use within the callback, a pointer to a key which can be used to delete the cached entry, and a 64 bit unsigned integer specifying the size of this key.</p>
<h2>Connection-oriented functions</h2>
<h3>s2n_connection_new</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="structs2n__connection.html">s2n_connection</a> * <a class="code" href="s2n_8h.html#acffb3a7098380db63bc23498482ee4b9">s2n_connection_new</a>(s2n_mode <a class="code" href="structs2n__connection.html#a080df3a36b82d7a11f200fdf1a38f360">mode</a>);</div></div><!-- fragment --><p><b>s2n_connection_new</b> creates a new connection object. Each s2n SSL/TLS connection uses one of these objects. These connection objects can be operated on by up to two threads at a time, one sender and one receiver, but neither sending nor receiving are atomic, so if these objects are being called by multiple sender or receiver threads, you must perform your own locking to ensure that only one sender or receiver is active at a time. The <b>mode</b> parameters specifies if the caller is a server, or is a client.</p>
<p>Connections objects are re-usable across many connections, and should be re-used (to avoid deallocating and allocating memory). You should wipe connections immediately after use.</p>
<h3>s2n_connection_set_config</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a85ced5d91831da552d5c4997a3f30abb">s2n_connection_set_config</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn, </div><div class="line">                              <span class="keyword">struct</span> <a class="code" href="structs2n__config.html">s2n_config</a> *config);</div></div><!-- fragment --><p><b>s2n_connection_set_config</b> Associates a configuration object with a connection.</p>
<h3>s2n_connection_set_fd</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a80776ecf7e726f52165cdec5e2652d1e">s2n_connection_set_fd</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn, </div><div class="line">                          <span class="keywordtype">int</span> <a class="code" href="structs2n__connection.html#ab8b1e66f9a7b17fa4541b1733b87e011">readfd</a>);</div><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a098af174491e2fe62cb0635d1adab854">s2n_connection_set_read_fd</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn, </div><div class="line">                               <span class="keywordtype">int</span> <a class="code" href="structs2n__connection.html#ab8b1e66f9a7b17fa4541b1733b87e011">readfd</a>);</div><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#ab340fbb2459b04d8f6d2803483a14ab1">s2n_connection_set_write_fd</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn, </div><div class="line">                                <span class="keywordtype">int</span> <a class="code" href="structs2n__connection.html#abb118879baad1066df4d078fdb2da908">writefd</a>);</div></div><!-- fragment --><p><b>s2n_connection_set_fd</b> sets the file-descriptor for an s2n connection. This file-descriptor should be active and connected. s2n also supports setting the read and write file-descriptors to different values (for pipes or other unusual types of I/O).</p>
<h3>s2n_set_server_name</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a9b37f3c0364e6de9f0b534e624204f62">s2n_set_server_name</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn, </div><div class="line">                        <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structs2n__connection.html#aaeec7205ccf6834a5eaf18d9a5eb8936">server_name</a>);</div></div><!-- fragment --><p><b>s2n_set_server_name</b> Sets the server name for the connection. In future, this can be used by clients who wish to use the TLS "Server Name indicator" extension. At present, client functionality is disabled.</p>
<h3>s2n_get_server_name</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="s2n_8h.html#a541a5e22fc8b6295e4c6bb1692cdd850">s2n_get_server_name</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_get_server_name</b> returns the server name associated with a connection, or NULL if none is found. This can be used by a server to determine which server name the client is using.</p>
<h3>s2n_connection_set_blinding</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a7b2423a701b89f7ca3a4de550c519d35">s2n_connection_set_blinding</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn, s2n_blinding <a class="code" href="structs2n__connection.html#a1bfa8f7b48f1d0d742fed4a18b4d3f40">blinding</a>);</div></div><!-- fragment --><p><b>s2n_connection_set_blinding</b> can be used to configure s2n to either use built-in blinding (set blinding to S2N_BUILT_IN_BLINDING) or self-service blinding (set blinding to S2N_SELF_SERVICE_BLINDING).</p>
<h3>s2n_connection_get_delay</h3>
<div class="fragment"><div class="line">int64_t <a class="code" href="s2n_8h.html#aebf38ba3c1ebd08e7fdd185d8f3ec521">s2n_connection_get_delay</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_connection_get_delay</b> returns the number of nanoseconds an application using self-service blinding should pause before calling close() or shutdown().</p>
<h3><a class="el" href="s2n__connection_8c.html#ab242f62c5824c72476844970b1ae7301">s2n_connection_prefer_throughput(struct s2n_connection *conn)</a></h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#ab242f62c5824c72476844970b1ae7301">s2n_connection_prefer_throughput</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a332427237ca8907196034ac5768a65bf">s2n_connection_prefer_low_latency</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_connection_prefer_throughput</b> and <b>s2n_connection_prefer_low_latency</b> change the behavior of s2n when sending data to prefer either throughput or low latency. Connections prefering low latency will be encrypted using small record sizes that can be decrypted sooner by the recipient. Connections prefering throughput will use large record sizes that minimize overhead.</p>
<p>Connections prefer low latency by default.</p>
<h3>s2n_connection_get_wire_bytes</h3>
<div class="fragment"><div class="line">uint64_t <a class="code" href="s2n_8h.html#a4d1194b561c825208d387b4660670b63">s2n_connection_get_wire_bytes_in</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div><div class="line">uint64_t <a class="code" href="s2n_8h.html#a43ef96c4123345ccc7952a387125409e">s2n_connection_get_wire_bytes_out</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_connection_get_wire_bytes_in</b> and <b>s2n_connection_get_wire_bytes_out</b> return the number of bytes transmitted by s2n "on the wire", in and out respectively.</p>
<h3>s2n_connection_get_protocol_version</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a3d4e8c095c40ea7689f14022567cd3e9">s2n_connection_get_client_hello_version</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#af15303e1d72a95320b6138edeef7a6ab">s2n_connection_get_client_protocol_version</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#ae2ea6a2e6468883f56459431f2024b0f">s2n_connection_get_server_protocol_version</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a4cb9df94e1fe137f10040fbfc1ad98f9">s2n_connection_get_actual_protocol_version</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_connection_get_client_protocol_version</b> returns the protocol version number supported by the client, <b>s2n_connection_get_server_protocol_version</b> returns the protocol version number supported by the server and <b>s2n_connection_get_actual_protocol_version</b> returns the protocol version number actually used by s2n for the connection. <b>s2n_connection_get_client_hello_version</b> returns the protocol version used in the initial client hello message.</p>
<p>Each version number value corresponds to the macros defined as <b>S2N_SSLv2</b>, <b>S2N_SSLv3</b>, <b>S2N_TLS10</b>, <b>S2N_TLS11</b> and <b>S2N_TLS12</b>.</p>
<h3>s2n_get_application_protocol</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="s2n_8h.html#a5a0e7b4549f38de84e325e221b596908">s2n_get_application_protocol</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_get_application_protocol</b> returns the negotiated application protocol for a <b><a class="el" href="structs2n__connection.html">s2n_connection</a></b>. In the event of no protocol being negotiated, NULL is returned.</p>
<h3>s2n_connection_get_ocsp_response</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> uint8_t *<a class="code" href="s2n_8h.html#a2b18cd3437636a7a21e10f3d5d09ff9d">s2n_connection_get_ocsp_response</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn, uint32_t *<a class="code" href="crypto_2asn1_2asn1_8h.html#a5a2d57a92488e64c730cabc247c9d5b5">length</a>);</div></div><!-- fragment --><p><b>s2n_connection_get_ocsp_response</b> returns the OCSP response sent by a server during the handshake. If no status response is received, NULL is returned.</p>
<h3>s2n_connection_get_alert</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a6726a1cbae275671f2751ac610dc5f0f">s2n_connection_get_alert</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p>If a connection was shut down by the peer, <b>s2n_connection_get_alert</b> returns the TLS alert code that caused a connection to be shut down. s2n considers all TLS alerts fatal and shuts down a connection whenever one is received.</p>
<h3>s2n_connection_get_cipher</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="s2n_8h.html#a119c0252cf7edde4d4a5c65f8cd23721">s2n_connection_get_cipher</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_connection_get_cipher</b> returns a string indicating the cipher suite negotiated by s2n for a connection in Openssl format, e.g. "ECDHE-RSA-AES128-GCM-SHA256".</p>
<h3>s2n_connection_wipe</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#aa869211ca9b49f497cdb5579935203de">s2n_connection_wipe</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_connection_wipe</b> erases all data associated with a connection including pending reads.</p>
<h3>s2n_connection_free</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a03ed084d7fb943c7d32b13075ed8eff7">s2n_connection_free</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn);</div></div><!-- fragment --><p><b>s2n_connection_free</b> frees the memory associated with an <a class="el" href="structs2n__connection.html">s2n_connection</a> handle.</p>
<h2>I/O functions</h2>
<p>s2n supports both blocking and non-blocking I/O. To use s2n in non-blocking mode, set the underlying file descriptors as non-blocking (i.e. with <b>fcntl</b>). In blocking mode, each s2n I/O function will not return until it is complete. In non-blocking mode an s2n I/O function may return while there is still I/O pending. In this case the value of the <b>blocked</b> parameter will be set to either <b>S2N_BLOCKED_ON_READ</b> or <b>S2N_BLOCKED_ON_WRITE</b>, depending on the direction in which s2n is blocked.</p>
<p>s2n I/O functions should be called repeatedly until the <b>blocked</b> parameter is <b>S2N_NOT_BLOCKED</b>.</p>
<h3>s2n_negotiate</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a309d98d4c1adfd10c5dd62192f4c1051">s2n_negotiate</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn, s2n_blocked_status *blocked);</div></div><!-- fragment --><p><b>s2n_negotiate</b> performs the initial "handshake" phase of a TLS connection and must be called before any <b>s2n_recv</b> or <b>s2n_send</b> calls.</p>
<h3>s2n_send</h3>
<div class="fragment"><div class="line">ssize_t <a class="code" href="s2n_8h.html#a6d221800840cc73c57109088dac2f467">s2n_send</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn </div><div class="line">              <span class="keywordtype">void</span> *buf,</div><div class="line">              ssize_t size,</div><div class="line">              s2n_blocked_status *blocked);</div></div><!-- fragment --><p><b>s2n_send</b> writes and encrypts <b>size* of **buf</b> data to the associated connection. <b>s2n_send</b> will return the number of bytes written, and may indicate a partial write. Partial writes are possible not just for non-blocking I/O, but also for connections aborted while active. <b>NOTE:</b> Unlike OpenSSL, repeated calls to <b>s2n_send</b> should not duplicate the original parameters, but should update <b>buf</b> and <b>size</b> per the indication of size written. For example;</p>
<div class="fragment"><div class="line">s2n_blocked_status blocked;</div><div class="line"><span class="keywordtype">int</span> written = 0;</div><div class="line"><span class="keywordtype">char</span> data[10]; <span class="comment">/* Some data we want to write */</span></div><div class="line"><span class="keywordflow">do</span> {</div><div class="line">    <span class="keywordtype">int</span> w = <a class="code" href="s2n_8h.html#a6d221800840cc73c57109088dac2f467">s2n_send</a>(conn, data + written, 10 - written, &amp;blocked);</div><div class="line">    <span class="keywordflow">if</span> (w &lt; 0) {</div><div class="line">        <span class="comment">/* Some kind of error */</span></div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    written += w;</div><div class="line">} <span class="keywordflow">while</span> (blocked != <a class="code" href="s2n_8h.html#af70ca0b089daa98cd79a424d3f6af15da7afdc9e789b567fe89c7142f34ec3ebd">S2N_NOT_BLOCKED</a>); </div></div><!-- fragment --><h3>s2n_recv</h3>
<div class="fragment"><div class="line">ssize_t <a class="code" href="s2n_8h.html#afede11e597a4db3024ec2b68733a643d">s2n_recv</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn,</div><div class="line">             <span class="keywordtype">void</span> *buf,</div><div class="line">             ssize_t size,</div><div class="line">             s2n_blocked_status *blocked);</div></div><!-- fragment --><p><b>s2n_recv</b> decrypts and reads <b>size* to **buf</b> data from the associated connection. <b>s2n_recv</b> will return the number of bytes read and also return "0" on connection shutdown by the peer.</p>
<p><b>NOTE:</b> Unlike OpenSSL, repeated calls to <b>s2n_recv</b> should not duplicate the original parameters, but should update <b>buf</b> and <b>size</b> per the indication of size read. For example;</p>
<div class="fragment"><div class="line">s2n_blocked_status blocked;</div><div class="line"><span class="keywordtype">int</span> bytes_read = 0;</div><div class="line"><span class="keywordtype">char</span> data[10];</div><div class="line"><span class="keywordflow">do</span> {</div><div class="line">    <span class="keywordtype">int</span> r = <a class="code" href="s2n_8h.html#afede11e597a4db3024ec2b68733a643d">s2n_recv</a>(conn, data + bytes_read, 10 - bytes_read, &amp;blocked);</div><div class="line">    <span class="keywordflow">if</span> (r &lt; 0) {</div><div class="line">        <span class="comment">/* Some kind of error */</span></div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    bytes_read += r;</div><div class="line">} <span class="keywordflow">while</span> (blocked != <a class="code" href="s2n_8h.html#af70ca0b089daa98cd79a424d3f6af15da7afdc9e789b567fe89c7142f34ec3ebd">S2N_NOT_BLOCKED</a>);</div></div><!-- fragment --><h3>s2n_shutdown</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="s2n_8h.html#a1cb034f97199a7f7d7888a447cf0fe67">s2n_shutdown</a>(<span class="keyword">struct</span> <a class="code" href="structs2n__connection.html">s2n_connection</a> *conn,</div><div class="line">                 s2n_blocked_status *blocked);</div></div><!-- fragment --><p><b>s2n_shutdown</b> shuts down the s2n connection. Once a connection has been shut down it is not available for reading or writing.</p>
<h1>Examples</h1>
<p>To understand the API it may be easiest to see examples in action. s2n's <a href="https://github.com/awslabs/s2n/blob/master/bin/">bin/</a> directory includes an example client (s2nc) and server (s2nd). </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
