\hypertarget{s2n__record__test_8c}{}\section{s2n-\/master/tests/unit/s2n\+\_\+record\+\_\+test.c File Reference}
\label{s2n__record__test_8c}\index{s2n-\/master/tests/unit/s2n\+\_\+record\+\_\+test.\+c@{s2n-\/master/tests/unit/s2n\+\_\+record\+\_\+test.\+c}}
{\ttfamily \#include \char`\"{}s2n\+\_\+test.\+h\char`\"{}}\\*
{\ttfamily \#include $<$string.\+h$>$}\\*
{\ttfamily \#include $<$stdio.\+h$>$}\\*
{\ttfamily \#include $<$s2n.\+h$>$}\\*
{\ttfamily \#include \char`\"{}testlib/s2n\+\_\+testlib.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}tls/s2n\+\_\+cipher\+\_\+suites.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}stuffer/s2n\+\_\+stuffer.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}crypto/s2n\+\_\+cipher.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}utils/s2n\+\_\+random.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}crypto/s2n\+\_\+hmac.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}tls/s2n\+\_\+record.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}tls/s2n\+\_\+prf.\+h\char`\"{}}\\*
Include dependency graph for s2n\+\_\+record\+\_\+test.\+c\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{s2n__record__test_8c__incl}
\end{center}
\end{figure}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{s2n__record__test_8c_a85da3429301bd608c4914ca60907d1b9}{mock\+\_\+block\+\_\+endecrypt} (struct \hyperlink{structs2n__session__key}{s2n\+\_\+session\+\_\+key} $\ast$key, struct \hyperlink{structs2n__blob}{s2n\+\_\+blob} $\ast$iv, struct \hyperlink{structs2n__blob}{s2n\+\_\+blob} $\ast$in, struct \hyperlink{structs2n__blob}{s2n\+\_\+blob} $\ast$out)
\item 
int \hyperlink{s2n__record__test_8c_a3c04138a5bfe5d72780bb7e82a18e627}{main} (int argc, char $\ast$$\ast$argv)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structs2n__cipher}{s2n\+\_\+cipher} \hyperlink{s2n__record__test_8c_a56c813798b2cf3879a888065de603079}{mock\+\_\+block\+\_\+cipher}
\item 
struct \hyperlink{structs2n__cipher__suite}{s2n\+\_\+cipher\+\_\+suite} \hyperlink{s2n__record__test_8c_a24bb6dc0a973f4e55c57a85b0766340f}{mock\+\_\+block\+\_\+cipher\+\_\+suite}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\index{s2n\+\_\+record\+\_\+test.\+c@{s2n\+\_\+record\+\_\+test.\+c}!mock\+\_\+block\+\_\+endecrypt@{mock\+\_\+block\+\_\+endecrypt}}
\index{mock\+\_\+block\+\_\+endecrypt@{mock\+\_\+block\+\_\+endecrypt}!s2n\+\_\+record\+\_\+test.\+c@{s2n\+\_\+record\+\_\+test.\+c}}
\subsubsection[{\texorpdfstring{mock\+\_\+block\+\_\+endecrypt(struct s2n\+\_\+session\+\_\+key $\ast$key, struct s2n\+\_\+blob $\ast$iv, struct s2n\+\_\+blob $\ast$in, struct s2n\+\_\+blob $\ast$out)}{mock_block_endecrypt(struct s2n_session_key *key, struct s2n_blob *iv, struct s2n_blob *in, struct s2n_blob *out)}}]{\setlength{\rightskip}{0pt plus 5cm}int mock\+\_\+block\+\_\+endecrypt (
\begin{DoxyParamCaption}
\item[{struct {\bf s2n\+\_\+session\+\_\+key} $\ast$}]{key, }
\item[{struct {\bf s2n\+\_\+blob} $\ast$}]{iv, }
\item[{struct {\bf s2n\+\_\+blob} $\ast$}]{in, }
\item[{struct {\bf s2n\+\_\+blob} $\ast$}]{out}
\end{DoxyParamCaption}
)}\hypertarget{s2n__record__test_8c_a85da3429301bd608c4914ca60907d1b9}{}\label{s2n__record__test_8c_a85da3429301bd608c4914ca60907d1b9}


Definition at line 34 of file s2n\+\_\+record\+\_\+test.\+c.


\begin{DoxyCode}
35 \{
36     \textcolor{keywordflow}{return} 0;
37 \}
\end{DoxyCode}
\index{s2n\+\_\+record\+\_\+test.\+c@{s2n\+\_\+record\+\_\+test.\+c}!main@{main}}
\index{main@{main}!s2n\+\_\+record\+\_\+test.\+c@{s2n\+\_\+record\+\_\+test.\+c}}
\subsubsection[{\texorpdfstring{main(int argc, char $\ast$$\ast$argv)}{main(int argc, char **argv)}}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{int}]{argc, }
\item[{char $\ast$$\ast$}]{argv}
\end{DoxyParamCaption}
)}\hypertarget{s2n__record__test_8c_a3c04138a5bfe5d72780bb7e82a18e627}{}\label{s2n__record__test_8c_a3c04138a5bfe5d72780bb7e82a18e627}


Definition at line 60 of file s2n\+\_\+record\+\_\+test.\+c.


\begin{DoxyCode}
61 \{
62     \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *conn;
63     uint8\_t mac\_key[] = \textcolor{stringliteral}{"sample mac key"};
64     \textcolor{keyword}{struct }\hyperlink{structs2n__blob}{s2n\_blob} fixed\_iv = \{.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data} = mac\_key,.size = \textcolor{keyword}{sizeof}(mac\_key) \};
65     \textcolor{keyword}{struct }\hyperlink{structs2n__hmac__state}{s2n\_hmac\_state} check\_mac;
66     uint8\_t random\_data[\hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH} + 1];
67     \textcolor{keyword}{struct }\hyperlink{structs2n__blob}{s2n\_blob} r = \{.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data} = random\_data, .size = \textcolor{keyword}{sizeof}(random\_data)\};
68 
69     \hyperlink{s2n__test_8h_abef58b8851265310b43e5b6d8c1d2ff5}{BEGIN\_TEST}();
70 
71     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ad5056a3fc151619a2935471a5861fc3d}{s2n\_hmac\_init}(&check\_mac, 
      \hyperlink{s2n__hmac_8h_a05e34c658a0066b52f746b931d53dbf8a4c54826ffafbb42002b6097db113a742}{S2N\_HMAC\_SHA1}, fixed\_iv.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}, fixed\_iv.\hyperlink{structs2n__blob_ab2c6b258f02add8fdf4cfc7c371dd772}{size}));
72     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{global__overrides_8c_a803d79131d0fb9d77393aae0cdc2c169}{s2n\_get\_urandom\_data}(&r));
73     \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
74 
75     \textcolor{comment}{/* Peer and we are in sync */}
76     conn->\hyperlink{structs2n__connection_abfab1f3796089e3576e73286c0b6889c}{server} = &conn->\hyperlink{structs2n__connection_afd0633da7a12696e4a8fdbf802701a05}{initial};
77     conn->\hyperlink{structs2n__connection_a052f81d7dc7e2612341fe0da1e749ebd}{client} = &conn->\hyperlink{structs2n__connection_afd0633da7a12696e4a8fdbf802701a05}{initial};
78 
79     \textcolor{comment}{/* test the null cipher. */}
80     conn->\hyperlink{structs2n__connection_afd0633da7a12696e4a8fdbf802701a05}{initial}.\hyperlink{structs2n__crypto__parameters_a5446cce0337d14b74b38f2a81ea19670}{cipher\_suite} = &\hyperlink{s2n__cipher__suites_8c_a961160365c54a2770d684943f033f4de}{s2n\_null\_cipher\_suite};
81     conn->\hyperlink{structs2n__connection_af9b47a1de13de52e7beddb948a40fec1}{actual\_protocol\_version} = \hyperlink{s2n_8h_a2e4a51448d3a9ea14b506ac2573f9bae}{S2N\_TLS11};
82 
83     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i <= \hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH} + 1; i++) \{
84         \textcolor{keyword}{struct }\hyperlink{structs2n__blob}{s2n\_blob} in = \{.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data} = random\_data,.size = i \};
85         \textcolor{keywordtype}{int} bytes\_written;
86 
87         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}));
88         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(bytes\_written = \hyperlink{s2n__record_8h_a345384c81da35d41574e7a2c8319c7e3}{s2n\_record\_write}(conn, 
      \hyperlink{s2n__tls__parameters_8h_a5104f80ba38ebfd2266b1ec313f0aeb2}{TLS\_APPLICATION\_DATA}, &in));
89 
90         \textcolor{keywordflow}{if} (i < \hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH}) \{
91             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(bytes\_written, i);
92         \} \textcolor{keywordflow}{else} \{
93             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(bytes\_written, \hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH});
94         \}
95 
96         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[0], 
      \hyperlink{s2n__tls__parameters_8h_a5104f80ba38ebfd2266b1ec313f0aeb2}{TLS\_APPLICATION\_DATA});
97         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[1], 3);
98         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[2], 2);
99         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[3], (bytes\_written >> 8) & 0xff);
100         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[4], bytes\_written & 0xff);
101         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(memcmp(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data} + 5, random\_data, bytes\_written), 0)
      ;
102 
103         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->\hyperlink{structs2n__connection_a556c2665a42d6fd91dd28fc73d50d21e}{in}));
104         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->
      \hyperlink{structs2n__connection_a005c1df7387f2c53061e9c9432f70aca}{header\_in}));
105         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}, &conn->
      \hyperlink{structs2n__connection_a005c1df7387f2c53061e9c9432f70aca}{header\_in}, 5));
106         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}, &conn->
      \hyperlink{structs2n__connection_a556c2665a42d6fd91dd28fc73d50d21e}{in}, \hyperlink{s2n__stuffer_8h_a56d3da0e05e4c05eb87a343306c4f170}{s2n\_stuffer\_data\_available}(&conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out})));
107 
108         uint8\_t content\_type;
109         uint16\_t fragment\_length;
110         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__record_8h_af0794788139e3e2975022dd47f983eda}{s2n\_record\_header\_parse}(conn, &content\_type, &
      fragment\_length));
111         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__record_8h_a26b47800a66fc8e167d92b302e0b7079}{s2n\_record\_parse}(conn));
112         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(content\_type, \hyperlink{s2n__tls__parameters_8h_a5104f80ba38ebfd2266b1ec313f0aeb2}{TLS\_APPLICATION\_DATA});
113         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(fragment\_length, bytes\_written);
114     \}
115 
116     \textcolor{comment}{/* test a fake streaming cipher with a MAC */}
117     conn->\hyperlink{structs2n__connection_afd0633da7a12696e4a8fdbf802701a05}{initial}.\hyperlink{structs2n__crypto__parameters_a5446cce0337d14b74b38f2a81ea19670}{cipher\_suite}->\hyperlink{structs2n__cipher__suite_a90bc81bf7297c0cc02ecd7b52e436b5e}{hmac\_alg} = 
      \hyperlink{s2n__hmac_8h_a05e34c658a0066b52f746b931d53dbf8a4c54826ffafbb42002b6097db113a742}{S2N\_HMAC\_SHA1};
118     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ad5056a3fc151619a2935471a5861fc3d}{s2n\_hmac\_init}(&conn->\hyperlink{structs2n__connection_afd0633da7a12696e4a8fdbf802701a05}{initial}.
      \hyperlink{structs2n__crypto__parameters_a9e84d70c1483dbddcb35a95aca818166}{client\_record\_mac}, \hyperlink{s2n__hmac_8h_a05e34c658a0066b52f746b931d53dbf8a4c54826ffafbb42002b6097db113a742}{S2N\_HMAC\_SHA1}, mac\_key, \textcolor{keyword}{sizeof}(mac\_key)));
119     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ad5056a3fc151619a2935471a5861fc3d}{s2n\_hmac\_init}(&conn->\hyperlink{structs2n__connection_afd0633da7a12696e4a8fdbf802701a05}{initial}.
      \hyperlink{structs2n__crypto__parameters_a2d6bba69a948270d25b1e24876225224}{server\_record\_mac}, \hyperlink{s2n__hmac_8h_a05e34c658a0066b52f746b931d53dbf8a4c54826ffafbb42002b6097db113a742}{S2N\_HMAC\_SHA1}, mac\_key, \textcolor{keyword}{sizeof}(mac\_key)));
120     conn->\hyperlink{structs2n__connection_afd0633da7a12696e4a8fdbf802701a05}{initial}.\hyperlink{structs2n__crypto__parameters_a5446cce0337d14b74b38f2a81ea19670}{cipher\_suite} = &\hyperlink{s2n__cipher__suites_8c_a961160365c54a2770d684943f033f4de}{s2n\_null\_cipher\_suite};
121     conn->\hyperlink{structs2n__connection_af9b47a1de13de52e7beddb948a40fec1}{actual\_protocol\_version} = \hyperlink{s2n_8h_a2e4a51448d3a9ea14b506ac2573f9bae}{S2N\_TLS11};
122 
123     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i <= \hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH} + 1; i++) \{
124         \textcolor{keyword}{struct }\hyperlink{structs2n__blob}{s2n\_blob} in = \{.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data} = random\_data,.size = i \};
125         \textcolor{keywordtype}{int} bytes\_written;
126 
127         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ac4f30ec554d9a717c6269a5de8ae4acf}{s2n\_hmac\_reset}(&check\_mac));
128         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, conn->
      \hyperlink{structs2n__connection_afd0633da7a12696e4a8fdbf802701a05}{initial}.\hyperlink{structs2n__crypto__parameters_a286710aff413808336b2f294554c7e55}{server\_sequence\_number}, 8));
129 
130         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}));
131         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(bytes\_written = \hyperlink{s2n__record_8h_a345384c81da35d41574e7a2c8319c7e3}{s2n\_record\_write}(conn, 
      \hyperlink{s2n__tls__parameters_8h_a5104f80ba38ebfd2266b1ec313f0aeb2}{TLS\_APPLICATION\_DATA}, &in));
132 
133         \textcolor{keywordflow}{if} (i < \hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH} - 20) \{
134             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(bytes\_written, i);
135         \} \textcolor{keywordflow}{else} \{
136             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(bytes\_written, \hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH} - 20
      );
137         \}
138 
139         uint16\_t predicted\_length = bytes\_written + 20;
140         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[0], 
      \hyperlink{s2n__tls__parameters_8h_a5104f80ba38ebfd2266b1ec313f0aeb2}{TLS\_APPLICATION\_DATA});
141         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[1], 3);
142         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[2], 2);
143         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[3], (predicted\_length >> 8) & 0xff);
144         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}[4], predicted\_length & 0xff);
145         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(memcmp(conn->\hyperlink{structs2n__connection_aa4edd9e7ae7d0068c43a8c3d54073da0}{out}.\hyperlink{structs2n__stuffer_ab95f00f583f1cb41ae00918e9ea180c9}{blob}.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data} + 5, random\_data, bytes\_written), 0)
146 
147         uint8\_t top = bytes\_written >> 8;
148         uint8\_t bot = bytes\_written & 0xff;
149         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, conn->out.blob.
      \hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data}, 3));
150         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, &top, 1));
151         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, &bot, 1));
152         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, random\_data, bytes\_written)
      );
153 
154         uint8\_t check\_digest[20];
155         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a4501c4b9ea25f86e9c6c0e9d1bd9276b}{s2n\_hmac\_digest}(&check\_mac, check\_digest, 20));
156         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a7787cefe78aedac6b20db11cc451a433}{s2n\_hmac\_digest\_verify}(conn->out.blob.data + 5 +
       bytes\_written, check\_digest, 20));
157 
158         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->in));
159         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->header\_in));
160         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->header\_in, 5));
161         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->in, 
      \hyperlink{s2n__stuffer_8h_a56d3da0e05e4c05eb87a343306c4f170}{s2n\_stuffer\_data\_available}(&conn->out)));
162 
163         uint8\_t original\_seq\_num[8];
164         memcpy(original\_seq\_num, conn->server->client\_sequence\_number, 8);
165 
166         uint8\_t content\_type;
167         uint16\_t fragment\_length;
168         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__record_8h_af0794788139e3e2975022dd47f983eda}{s2n\_record\_header\_parse}(conn, &content\_type, &
      fragment\_length));
169         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__record_8h_a26b47800a66fc8e167d92b302e0b7079}{s2n\_record\_parse}(conn));
170         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(content\_type, \hyperlink{s2n__tls__parameters_8h_a5104f80ba38ebfd2266b1ec313f0aeb2}{TLS\_APPLICATION\_DATA});
171         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(fragment\_length, predicted\_length);
172 
173         \textcolor{comment}{/* Similate a replay attack and verify that replaying the same record}
174 \textcolor{comment}{         * fails due to the sequence number check */}
175         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->in));
176         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a5d6db4ed8311ba66aec1227fceca24a9}{s2n\_stuffer\_reread}(&conn->out));
177         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->in, 
      \hyperlink{s2n__stuffer_8h_a56d3da0e05e4c05eb87a343306c4f170}{s2n\_stuffer\_data\_available}(&conn->out)));
178         \hyperlink{s2n__test_8h_aeb59a103f4f1f44916f910eb73080c3e}{EXPECT\_FAILURE}(\hyperlink{s2n__record_8h_a26b47800a66fc8e167d92b302e0b7079}{s2n\_record\_parse}(conn));
179 
180         \textcolor{comment}{/* Restore the original sequence number */}
181         memcpy(conn->server->client\_sequence\_number, original\_seq\_num, 8);
182 
183         \textcolor{comment}{/* Deliberately corrupt a byte of the output and check that the record}
184 \textcolor{comment}{         * won't parse }
185 \textcolor{comment}{         */}
186         uint32\_t byte\_to\_corrupt;
187         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(byte\_to\_corrupt = \hyperlink{s2n__random_8c_a8aabcb071120a9849d4615358000a8a6}{s2n\_public\_random}(fragment\_length))
      ;
188         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->header\_in));
189         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->in));
190         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a5d6db4ed8311ba66aec1227fceca24a9}{s2n\_stuffer\_reread}(&conn->out));
191         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->header\_in, 5));
192         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->in, 
      \hyperlink{s2n__stuffer_8h_a56d3da0e05e4c05eb87a343306c4f170}{s2n\_stuffer\_data\_available}(&conn->out)));
193 
194         conn->in.blob.data[byte\_to\_corrupt] += 1;
195         \hyperlink{s2n__test_8h_aeb59a103f4f1f44916f910eb73080c3e}{EXPECT\_FAILURE}(\hyperlink{s2n__record_8h_a26b47800a66fc8e167d92b302e0b7079}{s2n\_record\_parse}(conn));
196     \}
197 
198     \textcolor{comment}{/* Test a mock block cipher with a mac - in TLS1.0 mode */}
199     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ad5056a3fc151619a2935471a5861fc3d}{s2n\_hmac\_init}(&conn->initial.client\_record\_mac, 
      \hyperlink{s2n__hmac_8h_a05e34c658a0066b52f746b931d53dbf8a4c54826ffafbb42002b6097db113a742}{S2N\_HMAC\_SHA1}, mac\_key, sizeof(mac\_key)));
200     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ad5056a3fc151619a2935471a5861fc3d}{s2n\_hmac\_init}(&conn->initial.server\_record\_mac, S2N\_HMAC\_SHA1
      , mac\_key, sizeof(mac\_key)));
201     conn->actual\_protocol\_version = \hyperlink{s2n_8h_ab16c04a1d8479546aa124c4e52a1703f}{S2N\_TLS10};
202     conn->initial.cipher\_suite = &\hyperlink{s2n__record__test_8c_a24bb6dc0a973f4e55c57a85b0766340f}{mock\_block\_cipher\_suite};
203 
204     uint16\_t max\_aligned\_fragment = \hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH} - (
      \hyperlink{s2n__tls__parameters_8h_a97aa19b0694680ae6b26d130b3a15e1b}{S2N\_SMALL\_FRAGMENT\_LENGTH} % 16);
205     for (\textcolor{keywordtype}{int} i = 0; i <= max\_aligned\_fragment + 1; i++) \{
206         \textcolor{keyword}{struct }\hyperlink{structs2n__blob}{s2n\_blob} in = \{.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data} = random\_data,.size = i \};
207         \textcolor{keywordtype}{int} bytes\_written;
208 
209         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ac4f30ec554d9a717c6269a5de8ae4acf}{s2n\_hmac\_reset}(&check\_mac));
210         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, conn->initial.
      client\_sequence\_number, 8));
211 
212         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->out));
213         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(bytes\_written = \hyperlink{s2n__record_8h_a345384c81da35d41574e7a2c8319c7e3}{s2n\_record\_write}(conn, 
      TLS\_APPLICATION\_DATA, &in));
214 
215         \textcolor{keywordflow}{if} (i < max\_aligned\_fragment - 20 - 1) \{
216             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(bytes\_written, i);
217         \} \textcolor{keywordflow}{else} \{
218             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(bytes\_written, max\_aligned\_fragment - 20 - 1);
219         \}
220 
221         uint16\_t predicted\_length = bytes\_written + 1 + 20;
222         \textcolor{keywordflow}{if} (predicted\_length % 16) \{
223             predicted\_length += (16 - (predicted\_length % 16));
224         \}
225         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[0], TLS\_APPLICATION\_DATA);
226         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[1], 3);
227         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[2], 1);
228         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[3], (predicted\_length >> 8) & 0xff);
229         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[4], predicted\_length & 0xff);
230         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(memcmp(conn->out.blob.data + 5, random\_data, bytes\_written), 0);
231 
232         \textcolor{comment}{/* The last byte of out should indicate how much padding there was */}
233         uint8\_t \hyperlink{ssl__locl_8h_a4014c6f4a6fa0e565ca592bcaca0fa58}{p} = conn->out.blob.data[conn->out.write\_cursor - 1];
234         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(5 + bytes\_written + 20 + p + 1, 
      \hyperlink{s2n__stuffer_8h_a56d3da0e05e4c05eb87a343306c4f170}{s2n\_stuffer\_data\_available}(&conn->out));
235 
236         \textcolor{comment}{/* Check that the last 'p' bytes are all set to 'p' */}
237         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j <= \hyperlink{ssl__locl_8h_a4014c6f4a6fa0e565ca592bcaca0fa58}{p}; j++) \{
238             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[5 + bytes\_written + 20 + j], p);
239         \}
240 
241         uint8\_t top = bytes\_written >> 8;
242         uint8\_t bot = bytes\_written & 0xff;
243         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, conn->out.blob.data, 3));
244         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, &top, 1));
245         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, &bot, 1));
246         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, random\_data, bytes\_written)
      );
247 
248         uint8\_t check\_digest[20];
249         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a4501c4b9ea25f86e9c6c0e9d1bd9276b}{s2n\_hmac\_digest}(&check\_mac, check\_digest, 20));
250         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a7787cefe78aedac6b20db11cc451a433}{s2n\_hmac\_digest\_verify}(conn->out.blob.data + 5 +
       bytes\_written, check\_digest, 20));
251 
252         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->in));
253         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->header\_in));
254         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->header\_in, 5));
255         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->in, 
      \hyperlink{s2n__stuffer_8h_a56d3da0e05e4c05eb87a343306c4f170}{s2n\_stuffer\_data\_available}(&conn->out)));
256 
257         uint8\_t content\_type;
258         uint16\_t fragment\_length;
259         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__record_8h_af0794788139e3e2975022dd47f983eda}{s2n\_record\_header\_parse}(conn, &content\_type, &
      fragment\_length));
260         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__record_8h_a26b47800a66fc8e167d92b302e0b7079}{s2n\_record\_parse}(conn));
261         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(content\_type, TLS\_APPLICATION\_DATA);
262         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(fragment\_length, predicted\_length);
263     \}
264 
265     \textcolor{comment}{/* Test a mock block cipher with a mac - in TLS1.1+ mode */}
266     conn->initial.cipher\_suite->hmac\_alg = \hyperlink{s2n__hmac_8h_a05e34c658a0066b52f746b931d53dbf8a4c54826ffafbb42002b6097db113a742}{S2N\_HMAC\_SHA1};
267     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ad5056a3fc151619a2935471a5861fc3d}{s2n\_hmac\_init}(&conn->initial.client\_record\_mac, S2N\_HMAC\_SHA1
      , mac\_key, \textcolor{keyword}{sizeof}(mac\_key)));
268     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ad5056a3fc151619a2935471a5861fc3d}{s2n\_hmac\_init}(&conn->initial.server\_record\_mac, S2N\_HMAC\_SHA1
      , mac\_key, \textcolor{keyword}{sizeof}(mac\_key)));
269     conn->actual\_protocol\_version = \hyperlink{s2n_8h_a2e4a51448d3a9ea14b506ac2573f9bae}{S2N\_TLS11};
270     conn->initial.cipher\_suite = &\hyperlink{s2n__record__test_8c_a24bb6dc0a973f4e55c57a85b0766340f}{mock\_block\_cipher\_suite};
271 
272     max\_aligned\_fragment = S2N\_SMALL\_FRAGMENT\_LENGTH - (S2N\_SMALL\_FRAGMENT\_LENGTH % 16);
273     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i <= max\_aligned\_fragment + 1; i++) \{
274         \textcolor{keyword}{struct }\hyperlink{structs2n__blob}{s2n\_blob} in = \{.\hyperlink{structs2n__blob_abe222f6d3581e7920dcad5306cc906a8}{data} = random\_data,.size = i \};
275         \textcolor{keywordtype}{int} bytes\_written;
276 
277         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_ac4f30ec554d9a717c6269a5de8ae4acf}{s2n\_hmac\_reset}(&check\_mac));
278         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, conn->initial.
      client\_sequence\_number, 8));
279 
280         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->out));
281         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(bytes\_written = \hyperlink{s2n__record_8h_a345384c81da35d41574e7a2c8319c7e3}{s2n\_record\_write}(conn, 
      TLS\_APPLICATION\_DATA, &in));
282 
283         \textcolor{keywordflow}{if} (i < max\_aligned\_fragment - 20 - 16 - 1) \{
284             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(bytes\_written, i);
285         \} \textcolor{keywordflow}{else} \{
286             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(bytes\_written, max\_aligned\_fragment - 20 - 16 - 1);
287         \}
288 
289         uint16\_t predicted\_length = bytes\_written + 1 + 20 + 16;
290         \textcolor{keywordflow}{if} (predicted\_length % 16) \{
291             predicted\_length += (16 - (predicted\_length % 16));
292         \}
293         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[0], TLS\_APPLICATION\_DATA);
294         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[1], 3);
295         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[2], 2);
296         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[3], (predicted\_length >> 8) & 0xff);
297         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[4], predicted\_length & 0xff);
298         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(memcmp(conn->out.blob.data + 16 + 5, random\_data, bytes\_written), 0);
299 
300         \textcolor{comment}{/* The last byte of out should indicate how much padding there was */}
301         uint8\_t p = conn->out.blob.data[conn->out.write\_cursor - 1];
302         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(5 + bytes\_written + 20 + 16 + p + 1, 
      \hyperlink{s2n__stuffer_8h_a56d3da0e05e4c05eb87a343306c4f170}{s2n\_stuffer\_data\_available}(&conn->out));
303 
304         \textcolor{comment}{/* Check that the last 'p' bytes are all set to 'p' */}
305         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = 0; j <= \hyperlink{ssl__locl_8h_a4014c6f4a6fa0e565ca592bcaca0fa58}{p}; j++) \{
306             \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(conn->out.blob.data[5 + bytes\_written + 16 + 20 + j], p);
307         \}
308 
309         uint8\_t top = bytes\_written >> 8;
310         uint8\_t bot = bytes\_written & 0xff;
311         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, conn->out.blob.data, 3));
312         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, &top, 1));
313         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, &bot, 1));
314         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a9dbba560a1ef91d4c2114c792f221333}{s2n\_hmac\_update}(&check\_mac, random\_data, bytes\_written)
      );
315 
316         uint8\_t check\_digest[20];
317         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a4501c4b9ea25f86e9c6c0e9d1bd9276b}{s2n\_hmac\_digest}(&check\_mac, check\_digest, 20));
318         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__hmac_8c_a7787cefe78aedac6b20db11cc451a433}{s2n\_hmac\_digest\_verify}(conn->out.blob.data + 16 
      + 5 + bytes\_written, check\_digest, 20));
319         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->in));
320         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_a2b6b54f7856d92f06f823bc26d10f4ba}{s2n\_stuffer\_wipe}(&conn->header\_in));
321         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->header\_in, 5));
322         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__stuffer_8c_aff9283fe7b7a90e13c6c90014719354d}{s2n\_stuffer\_copy}(&conn->out, &conn->in, 
      \hyperlink{s2n__stuffer_8h_a56d3da0e05e4c05eb87a343306c4f170}{s2n\_stuffer\_data\_available}(&conn->out)));
323 
324         uint8\_t content\_type;
325         uint16\_t fragment\_length;
326         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__record_8h_af0794788139e3e2975022dd47f983eda}{s2n\_record\_header\_parse}(conn, &content\_type, &
      fragment\_length));
327         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n__record_8h_a26b47800a66fc8e167d92b302e0b7079}{s2n\_record\_parse}(conn));
328         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(content\_type, TLS\_APPLICATION\_DATA);
329         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(fragment\_length, predicted\_length);
330     \}
331 
332     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(conn));
333 
334     \hyperlink{s2n__test_8h_a45a83f30c32ca6265c28a1bef6dbe046}{END\_TEST}();
335 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{s2n__record__test_8c_a3c04138a5bfe5d72780bb7e82a18e627_cgraph}
\end{center}
\end{figure}




\subsection{Variable Documentation}
\index{s2n\+\_\+record\+\_\+test.\+c@{s2n\+\_\+record\+\_\+test.\+c}!mock\+\_\+block\+\_\+cipher@{mock\+\_\+block\+\_\+cipher}}
\index{mock\+\_\+block\+\_\+cipher@{mock\+\_\+block\+\_\+cipher}!s2n\+\_\+record\+\_\+test.\+c@{s2n\+\_\+record\+\_\+test.\+c}}
\subsubsection[{\texorpdfstring{mock\+\_\+block\+\_\+cipher}{mock_block_cipher}}]{\setlength{\rightskip}{0pt plus 5cm}struct {\bf s2n\+\_\+cipher} mock\+\_\+block\+\_\+cipher}\hypertarget{s2n__record__test_8c_a56c813798b2cf3879a888065de603079}{}\label{s2n__record__test_8c_a56c813798b2cf3879a888065de603079}
{\bfseries Initial value\+:}
\begin{DoxyCode}
= \{
    .type = S2N\_CBC,
    .key\_material\_size = 0,
    .io.cbc = \{
               .block\_size = 16,
               .record\_iv\_size = 16,
               .encrypt = \hyperlink{s2n__record__test_8c_a85da3429301bd608c4914ca60907d1b9}{mock\_block\_endecrypt},
               .decrypt = \hyperlink{s2n__record__test_8c_a85da3429301bd608c4914ca60907d1b9}{mock\_block\_endecrypt}\},
    .get\_encryption\_key = NULL,
    .get\_decryption\_key = NULL,
    .destroy\_key = NULL,
\}
\end{DoxyCode}


Definition at line 39 of file s2n\+\_\+record\+\_\+test.\+c.

\index{s2n\+\_\+record\+\_\+test.\+c@{s2n\+\_\+record\+\_\+test.\+c}!mock\+\_\+block\+\_\+cipher\+\_\+suite@{mock\+\_\+block\+\_\+cipher\+\_\+suite}}
\index{mock\+\_\+block\+\_\+cipher\+\_\+suite@{mock\+\_\+block\+\_\+cipher\+\_\+suite}!s2n\+\_\+record\+\_\+test.\+c@{s2n\+\_\+record\+\_\+test.\+c}}
\subsubsection[{\texorpdfstring{mock\+\_\+block\+\_\+cipher\+\_\+suite}{mock_block_cipher_suite}}]{\setlength{\rightskip}{0pt plus 5cm}struct {\bf s2n\+\_\+cipher\+\_\+suite} mock\+\_\+block\+\_\+cipher\+\_\+suite}\hypertarget{s2n__record__test_8c_a24bb6dc0a973f4e55c57a85b0766340f}{}\label{s2n__record__test_8c_a24bb6dc0a973f4e55c57a85b0766340f}
{\bfseries Initial value\+:}
\begin{DoxyCode}
= \{
    .name = \textcolor{stringliteral}{"TLS\_MOCK\_CBC"},
    .value = \{0x12, 0x34\},
    .key\_exchange\_alg = &\hyperlink{s2n__cipher__suites_8c_a613a9bfd4bc2d08b3c4bf076a6414cd7}{s2n\_rsa},
    .cipher = &\hyperlink{s2n__record__test_8c_a56c813798b2cf3879a888065de603079}{mock\_block\_cipher},
    .hmac\_alg = \hyperlink{s2n__hmac_8h_a05e34c658a0066b52f746b931d53dbf8a4c54826ffafbb42002b6097db113a742}{S2N\_HMAC\_SHA1}
\}
\end{DoxyCode}


Definition at line 52 of file s2n\+\_\+record\+\_\+test.\+c.

