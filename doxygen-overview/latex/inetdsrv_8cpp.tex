\hypertarget{inetdsrv_8cpp}{}\section{s2n-\/master/libcrypto-\/build/openssl/demos/ssl/inetdsrv.cpp File Reference}
\label{inetdsrv_8cpp}\index{s2n-\/master/libcrypto-\/build/openssl/demos/ssl/inetdsrv.\+cpp@{s2n-\/master/libcrypto-\/build/openssl/demos/ssl/inetdsrv.\+cpp}}
{\ttfamily \#include $<$stdio.\+h$>$}\\*
{\ttfamily \#include $<$errno.\+h$>$}\\*
{\ttfamily \#include \char`\"{}rsa.\+h\char`\"{}}\\*
{\ttfamily \#include $<$openssl/crypto.\+h$>$}\\*
{\ttfamily \#include $<$openssl/x509.\+h$>$}\\*
{\ttfamily \#include $<$openssl/pem.\+h$>$}\\*
{\ttfamily \#include $<$openssl/ssl.\+h$>$}\\*
{\ttfamily \#include $<$openssl/err.\+h$>$}\\*
Include dependency graph for inetdsrv.\+cpp\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{inetdsrv_8cpp__incl}
\end{center}
\end{figure}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{inetdsrv_8cpp_a0e26ea2db1b570d1a6fe1ac180ef4541}{H\+O\+ME}~\char`\"{}/usr/users/sampo/demo/\char`\"{}
\item 
\#define \hyperlink{inetdsrv_8cpp_a6bc79a8ee35d8ff8357a832dea12c3cc}{C\+E\+R\+TF}~\hyperlink{serv_8cpp_a0e26ea2db1b570d1a6fe1ac180ef4541}{H\+O\+ME} \char`\"{}plain-\/cert.\+pem\char`\"{}
\item 
\#define \hyperlink{inetdsrv_8cpp_ae0d5051a23e6338a6dd1a67be4cd2ac8}{K\+E\+YF}~\hyperlink{serv_8cpp_a0e26ea2db1b570d1a6fe1ac180ef4541}{H\+O\+ME} \char`\"{}plain-\/key.\+pem\char`\"{}
\item 
\#define \hyperlink{inetdsrv_8cpp_a3d6d377a4b9232b677b770822c3a6ed3}{C\+H\+K\+\_\+\+N\+U\+LL}(\hyperlink{include_2openssl_2pem_8h_a97dc7cf0c4554cbe9a4b58bfe9a749f5}{x})~if ((\hyperlink{include_2openssl_2pem_8h_a97dc7cf0c4554cbe9a4b58bfe9a749f5}{x})==N\+U\+LL) exit (1)
\item 
\#define \hyperlink{inetdsrv_8cpp_aa091ab859ba22622551371e9eb1300fe}{C\+H\+K\+\_\+\+E\+RR}(err,  s)
\item 
\#define \hyperlink{inetdsrv_8cpp_afd2737d414d1bf29a4b7e319851c4746}{C\+H\+K\+\_\+\+S\+SL}(err)~if ((err)==-\/1) \{ \hyperlink{include_2openssl_2err_8h_ae677e395b09f61df20dd6ed7a89c8a2c}{E\+R\+R\+\_\+print\+\_\+errors\+\_\+fp}(log); exit(2); \}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{hw__4758__cca_8h_afad4d591c7931ff6dc5bf69c76c96aa0}{void} \hyperlink{inetdsrv_8cpp_acdef7a1fd863a6d3770c1268cb06add3}{main} ()
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\index{inetdsrv.\+cpp@{inetdsrv.\+cpp}!H\+O\+ME@{H\+O\+ME}}
\index{H\+O\+ME@{H\+O\+ME}!inetdsrv.\+cpp@{inetdsrv.\+cpp}}
\subsubsection[{\texorpdfstring{H\+O\+ME}{HOME}}]{\setlength{\rightskip}{0pt plus 5cm}\#define H\+O\+ME~\char`\"{}/usr/users/sampo/demo/\char`\"{}}\hypertarget{inetdsrv_8cpp_a0e26ea2db1b570d1a6fe1ac180ef4541}{}\label{inetdsrv_8cpp_a0e26ea2db1b570d1a6fe1ac180ef4541}


Definition at line 17 of file inetdsrv.\+cpp.

\index{inetdsrv.\+cpp@{inetdsrv.\+cpp}!C\+E\+R\+TF@{C\+E\+R\+TF}}
\index{C\+E\+R\+TF@{C\+E\+R\+TF}!inetdsrv.\+cpp@{inetdsrv.\+cpp}}
\subsubsection[{\texorpdfstring{C\+E\+R\+TF}{CERTF}}]{\setlength{\rightskip}{0pt plus 5cm}\#define C\+E\+R\+TF~{\bf H\+O\+ME} \char`\"{}plain-\/cert.\+pem\char`\"{}}\hypertarget{inetdsrv_8cpp_a6bc79a8ee35d8ff8357a832dea12c3cc}{}\label{inetdsrv_8cpp_a6bc79a8ee35d8ff8357a832dea12c3cc}


Definition at line 18 of file inetdsrv.\+cpp.

\index{inetdsrv.\+cpp@{inetdsrv.\+cpp}!K\+E\+YF@{K\+E\+YF}}
\index{K\+E\+YF@{K\+E\+YF}!inetdsrv.\+cpp@{inetdsrv.\+cpp}}
\subsubsection[{\texorpdfstring{K\+E\+YF}{KEYF}}]{\setlength{\rightskip}{0pt plus 5cm}\#define K\+E\+YF~{\bf H\+O\+ME} \char`\"{}plain-\/key.\+pem\char`\"{}}\hypertarget{inetdsrv_8cpp_ae0d5051a23e6338a6dd1a67be4cd2ac8}{}\label{inetdsrv_8cpp_ae0d5051a23e6338a6dd1a67be4cd2ac8}


Definition at line 19 of file inetdsrv.\+cpp.

\index{inetdsrv.\+cpp@{inetdsrv.\+cpp}!C\+H\+K\+\_\+\+N\+U\+LL@{C\+H\+K\+\_\+\+N\+U\+LL}}
\index{C\+H\+K\+\_\+\+N\+U\+LL@{C\+H\+K\+\_\+\+N\+U\+LL}!inetdsrv.\+cpp@{inetdsrv.\+cpp}}
\subsubsection[{\texorpdfstring{C\+H\+K\+\_\+\+N\+U\+LL}{CHK_NULL}}]{\setlength{\rightskip}{0pt plus 5cm}\#define C\+H\+K\+\_\+\+N\+U\+LL(
\begin{DoxyParamCaption}
\item[{}]{{\bf x}}
\end{DoxyParamCaption}
)~if (({\bf x})==N\+U\+LL) exit (1)}\hypertarget{inetdsrv_8cpp_a3d6d377a4b9232b677b770822c3a6ed3}{}\label{inetdsrv_8cpp_a3d6d377a4b9232b677b770822c3a6ed3}


Definition at line 21 of file inetdsrv.\+cpp.

\index{inetdsrv.\+cpp@{inetdsrv.\+cpp}!C\+H\+K\+\_\+\+E\+RR@{C\+H\+K\+\_\+\+E\+RR}}
\index{C\+H\+K\+\_\+\+E\+RR@{C\+H\+K\+\_\+\+E\+RR}!inetdsrv.\+cpp@{inetdsrv.\+cpp}}
\subsubsection[{\texorpdfstring{C\+H\+K\+\_\+\+E\+RR}{CHK_ERR}}]{\setlength{\rightskip}{0pt plus 5cm}\#define C\+H\+K\+\_\+\+E\+RR(
\begin{DoxyParamCaption}
\item[{}]{err, }
\item[{}]{s}
\end{DoxyParamCaption}
)}\hypertarget{inetdsrv_8cpp_aa091ab859ba22622551371e9eb1300fe}{}\label{inetdsrv_8cpp_aa091ab859ba22622551371e9eb1300fe}
{\bfseries Value\+:}
\begin{DoxyCode}
\textcolor{keywordflow}{if} ((err)==-1) \(\backslash\)
                         \{ fprintf(log, \textcolor{stringliteral}{"%s %d\(\backslash\)n"}, (s), \hyperlink{_mac_socket_8cpp_ad65a8842cc674e3ddf69355898c0ecbf}{errno}); exit(1); \}
\end{DoxyCode}


Definition at line 22 of file inetdsrv.\+cpp.

\index{inetdsrv.\+cpp@{inetdsrv.\+cpp}!C\+H\+K\+\_\+\+S\+SL@{C\+H\+K\+\_\+\+S\+SL}}
\index{C\+H\+K\+\_\+\+S\+SL@{C\+H\+K\+\_\+\+S\+SL}!inetdsrv.\+cpp@{inetdsrv.\+cpp}}
\subsubsection[{\texorpdfstring{C\+H\+K\+\_\+\+S\+SL}{CHK_SSL}}]{\setlength{\rightskip}{0pt plus 5cm}\#define C\+H\+K\+\_\+\+S\+SL(
\begin{DoxyParamCaption}
\item[{}]{err}
\end{DoxyParamCaption}
)~if ((err)==-\/1) \{ {\bf E\+R\+R\+\_\+print\+\_\+errors\+\_\+fp}(log); exit(2); \}}\hypertarget{inetdsrv_8cpp_afd2737d414d1bf29a4b7e319851c4746}{}\label{inetdsrv_8cpp_afd2737d414d1bf29a4b7e319851c4746}


Definition at line 24 of file inetdsrv.\+cpp.



\subsection{Function Documentation}
\index{inetdsrv.\+cpp@{inetdsrv.\+cpp}!main@{main}}
\index{main@{main}!inetdsrv.\+cpp@{inetdsrv.\+cpp}}
\subsubsection[{\texorpdfstring{main()}{main()}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf void} main (
\begin{DoxyParamCaption}
\item[{{\bf void}}]{}
\end{DoxyParamCaption}
)}\hypertarget{inetdsrv_8cpp_acdef7a1fd863a6d3770c1268cb06add3}{}\label{inetdsrv_8cpp_acdef7a1fd863a6d3770c1268cb06add3}


Definition at line 26 of file inetdsrv.\+cpp.


\begin{DoxyCode}
27 \{
28   \textcolor{keywordtype}{int} err;
29   \hyperlink{structssl__ctx__st}{SSL\_CTX}* ctx;
30   \hyperlink{structssl__st}{SSL}*     ssl;
31   \hyperlink{structx509__st}{X509}*    client\_cert;
32   \textcolor{keywordtype}{char}*    str;
33   \textcolor{keywordtype}{char}     buf [4096];
34   FILE* log;
35   
36   log = fopen (\textcolor{stringliteral}{"/dev/console"}, \textcolor{stringliteral}{"a"});                     \hyperlink{inetdsrv_8cpp_a3d6d377a4b9232b677b770822c3a6ed3}{CHK\_NULL}(log);
37   fprintf (log, \textcolor{stringliteral}{"inetdserv %ld\(\backslash\)n"}, (\textcolor{keywordtype}{long})getpid());
38   
39   \hyperlink{include_2openssl_2ssl_8h_accb99e9f2be3b424cda1854c15f04a0f}{SSL\_load\_error\_strings}();
40   ctx = \hyperlink{include_2openssl_2ssl_8h_a4f19b32a7539849b34cab831fc4ea869}{SSL\_CTX\_new} (); \hyperlink{inetdsrv_8cpp_a3d6d377a4b9232b677b770822c3a6ed3}{CHK\_NULL}(ctx);
41   
42   err = \hyperlink{include_2openssl_2ssl_8h_ac6f703efc706ddb376fdf9b43abad613}{SSL\_CTX\_use\_RSAPrivateKey\_file} (ctx, \hyperlink{inetdsrv_8cpp_ae0d5051a23e6338a6dd1a67be4cd2ac8}{KEYF},  
      \hyperlink{include_2openssl_2ssl_8h_a780dd6463e7b75de14f0cf6d560efe18}{SSL\_FILETYPE\_PEM});
43   \hyperlink{inetdsrv_8cpp_afd2737d414d1bf29a4b7e319851c4746}{CHK\_SSL} (err);
44   
45   err = \hyperlink{include_2openssl_2ssl_8h_ae69fda52d4a4b7eace197b550ab0ad5f}{SSL\_CTX\_use\_certificate\_file}   (ctx, \hyperlink{inetdsrv_8cpp_a6bc79a8ee35d8ff8357a832dea12c3cc}{CERTF}, 
      \hyperlink{include_2openssl_2ssl_8h_a780dd6463e7b75de14f0cf6d560efe18}{SSL\_FILETYPE\_PEM});
46   \hyperlink{inetdsrv_8cpp_afd2737d414d1bf29a4b7e319851c4746}{CHK\_SSL} (err);
47 
48   \textcolor{comment}{/* inetd has already opened the TCP connection, so we can get right}
49 \textcolor{comment}{     down to business. */}
50   
51   ssl = \hyperlink{include_2openssl_2ssl_8h_a1874e8b72da196e3300b265937aa6da4}{SSL\_new} (ctx);  \hyperlink{inetdsrv_8cpp_a3d6d377a4b9232b677b770822c3a6ed3}{CHK\_NULL}(ssl);
52   \hyperlink{include_2openssl_2ssl_8h_a8b2968941090031b610cc8340da79743}{SSL\_set\_fd} (ssl,  fileno(stdin));
53   err = \hyperlink{include_2openssl_2ssl_8h_a6d20f62a4014e06cc1106e7d3e81c548}{SSL\_accept} (ssl);                                \hyperlink{inetdsrv_8cpp_afd2737d414d1bf29a4b7e319851c4746}{CHK\_SSL}(err);
54   
55   \textcolor{comment}{/* Get the cipher - opt */}
56   
57   fprintf (log, \textcolor{stringliteral}{"SSL connection using %s\(\backslash\)n"}, \hyperlink{include_2openssl_2ssl_8h_ac7cc576c30a48c7d07efb794361dfe21}{SSL\_get\_cipher} (ssl));
58   
59   \textcolor{comment}{/* Get client's certificate (note: beware of dynamic allocation) - opt */}
60 
61   client\_cert = SSL\_get\_peer\_certificate (ssl);
62   \textcolor{keywordflow}{if} (client\_cert != NULL) \{
63     fprintf (log, \textcolor{stringliteral}{"Client certificate:\(\backslash\)n"});
64     
65     str = \hyperlink{crypto_2x509_2x509_8h_a5f4ca5972b28da5c63da204422fb9636}{X509\_NAME\_oneline} (\hyperlink{crypto_2x509_2x509_8h_aff52c219295ce864fb20f88050f9963c}{X509\_get\_subject\_name} (client\_cert));
66     \hyperlink{inetdsrv_8cpp_a3d6d377a4b9232b677b770822c3a6ed3}{CHK\_NULL}(str);
67     fprintf (log, \textcolor{stringliteral}{"\(\backslash\)t subject: %s\(\backslash\)n"}, str);
68     \hyperlink{crypto_2crypto_8h_adc4794298fcd8ac85a7c5012ba242473}{OPENSSL\_free} (str);
69     
70     str = \hyperlink{crypto_2x509_2x509_8h_a5f4ca5972b28da5c63da204422fb9636}{X509\_NAME\_oneline} (\hyperlink{crypto_2x509_2x509_8h_ade3220b850537708545f660ee272d4e4}{X509\_get\_issuer\_name}  (client\_cert));
71     \hyperlink{inetdsrv_8cpp_a3d6d377a4b9232b677b770822c3a6ed3}{CHK\_NULL}(str);
72     fprintf (log, \textcolor{stringliteral}{"\(\backslash\)t issuer: %s\(\backslash\)n"}, str);
73     \hyperlink{crypto_2crypto_8h_adc4794298fcd8ac85a7c5012ba242473}{OPENSSL\_free} (str);
74     
75     \textcolor{comment}{/* We could do all sorts of certificate verification stuff here before}
76 \textcolor{comment}{       deallocating the certificate. */}
77     
78     X509\_free (client\_cert);
79   \} \textcolor{keywordflow}{else}
80     fprintf (log, \textcolor{stringliteral}{"Client doe not have certificate.\(\backslash\)n"});
81 
82   \textcolor{comment}{/* ------------------------------------------------- */}
83   \textcolor{comment}{/* DATA EXCHANGE: Receive message and send reply  */}
84   
85   err = \hyperlink{include_2openssl_2ssl_8h_a52e9679615a056e80c5d9bbb3324e1ca}{SSL\_read} (ssl, buf, \textcolor{keyword}{sizeof}(buf) - 1);  \hyperlink{inetdsrv_8cpp_afd2737d414d1bf29a4b7e319851c4746}{CHK\_SSL}(err);
86   buf[err] = \textcolor{charliteral}{'\(\backslash\)0'};
87   fprintf (log, \textcolor{stringliteral}{"Got %d chars:'%s'\(\backslash\)n"}, err, buf);
88   
89   err = \hyperlink{include_2openssl_2ssl_8h_ab1bc7aefe47a9d6801b113165ac8b1f0}{SSL\_write} (ssl, \textcolor{stringliteral}{"Loud and clear."}, strlen(\textcolor{stringliteral}{"Loud and clear."}));
90   \hyperlink{inetdsrv_8cpp_afd2737d414d1bf29a4b7e319851c4746}{CHK\_SSL}(err);
91 
92   \textcolor{comment}{/* Clean up. */}
93 
94   fclose (log);
95   \hyperlink{include_2openssl_2ssl_8h_add9f91511b7a494f4910b0e3567d7d99}{SSL\_free} (ssl);
96   \hyperlink{include_2openssl_2ssl_8h_ab78736366f5d2176ff31cc266467c7d7}{SSL\_CTX\_free} (ctx);
97 \}
\end{DoxyCode}


Here is the call graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{inetdsrv_8cpp_acdef7a1fd863a6d3770c1268cb06add3_cgraph}
\end{center}
\end{figure}


