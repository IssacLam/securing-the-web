\hypertarget{s2n__client__extensions__test_8c}{}\section{s2n-\/master/tests/unit/s2n\+\_\+client\+\_\+extensions\+\_\+test.c File Reference}
\label{s2n__client__extensions__test_8c}\index{s2n-\/master/tests/unit/s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c@{s2n-\/master/tests/unit/s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c}}
{\ttfamily \#include \char`\"{}s2n\+\_\+test.\+h\char`\"{}}\\*
{\ttfamily \#include $<$sys/wait.\+h$>$}\\*
{\ttfamily \#include $<$unistd.\+h$>$}\\*
{\ttfamily \#include $<$stdint.\+h$>$}\\*
{\ttfamily \#include $<$fcntl.\+h$>$}\\*
{\ttfamily \#include $<$errno.\+h$>$}\\*
{\ttfamily \#include $<$s2n.\+h$>$}\\*
{\ttfamily \#include \char`\"{}tls/s2n\+\_\+connection.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}tls/s2n\+\_\+handshake.\+h\char`\"{}}\\*
Include dependency graph for s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{s2n__client__extensions__test_8c__incl}
\end{center}
\end{figure}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{Z\+E\+R\+O\+\_\+\+T\+O\+\_\+\+T\+H\+I\+R\+T\+Y\+\_\+\+O\+NE}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{s2n__handshake_8h_a78b97fef55da786a15a849fd9d7e557c}{message\+\_\+type\+\_\+t} \hyperlink{s2n__client__extensions__test_8c_ad1a464c4f0d92cf0ac994ecd7693bd10}{s2n\+\_\+conn\+\_\+get\+\_\+current\+\_\+message\+\_\+type} (struct \hyperlink{structs2n__connection}{s2n\+\_\+connection} $\ast$conn)
\item 
int \hyperlink{s2n__client__extensions__test_8c_a3c04138a5bfe5d72780bb7e82a18e627}{main} (int argc, char $\ast$$\ast$argv)
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\index{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c@{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c}!Z\+E\+R\+O\+\_\+\+T\+O\+\_\+\+T\+H\+I\+R\+T\+Y\+\_\+\+O\+NE@{Z\+E\+R\+O\+\_\+\+T\+O\+\_\+\+T\+H\+I\+R\+T\+Y\+\_\+\+O\+NE}}
\index{Z\+E\+R\+O\+\_\+\+T\+O\+\_\+\+T\+H\+I\+R\+T\+Y\+\_\+\+O\+NE@{Z\+E\+R\+O\+\_\+\+T\+O\+\_\+\+T\+H\+I\+R\+T\+Y\+\_\+\+O\+NE}!s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c@{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c}}
\subsubsection[{\texorpdfstring{Z\+E\+R\+O\+\_\+\+T\+O\+\_\+\+T\+H\+I\+R\+T\+Y\+\_\+\+O\+NE}{ZERO_TO_THIRTY_ONE}}]{\setlength{\rightskip}{0pt plus 5cm}\#define Z\+E\+R\+O\+\_\+\+T\+O\+\_\+\+T\+H\+I\+R\+T\+Y\+\_\+\+O\+NE}\hypertarget{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{}\label{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}
{\bfseries Value\+:}
\begin{DoxyCode}
0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, \(\backslash\)
                            0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 
      0x1D, 0x1E, 0x1F
\end{DoxyCode}


Definition at line 29 of file s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c.



\subsection{Function Documentation}
\index{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c@{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c}!s2n\+\_\+conn\+\_\+get\+\_\+current\+\_\+message\+\_\+type@{s2n\+\_\+conn\+\_\+get\+\_\+current\+\_\+message\+\_\+type}}
\index{s2n\+\_\+conn\+\_\+get\+\_\+current\+\_\+message\+\_\+type@{s2n\+\_\+conn\+\_\+get\+\_\+current\+\_\+message\+\_\+type}!s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c@{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c}}
\subsubsection[{\texorpdfstring{s2n\+\_\+conn\+\_\+get\+\_\+current\+\_\+message\+\_\+type(struct s2n\+\_\+connection $\ast$conn)}{s2n_conn_get_current_message_type(struct s2n_connection *conn)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf message\+\_\+type\+\_\+t} s2n\+\_\+conn\+\_\+get\+\_\+current\+\_\+message\+\_\+type (
\begin{DoxyParamCaption}
\item[{struct {\bf s2n\+\_\+connection} $\ast$}]{conn}
\end{DoxyParamCaption}
)}\hypertarget{s2n__client__extensions__test_8c_ad1a464c4f0d92cf0ac994ecd7693bd10}{}\label{s2n__client__extensions__test_8c_ad1a464c4f0d92cf0ac994ecd7693bd10}


Definition at line 113 of file s2n\+\_\+handshake\+\_\+io.\+c.


\begin{DoxyCode}
114 \{
115     \textcolor{keywordflow}{return} \hyperlink{s2n__handshake__io_8c_a38b7ad67505bd79bb3599c3a1504c51e}{ACTIVE\_MESSAGE}(conn);
116 \}
\end{DoxyCode}


Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=269pt]{s2n__client__extensions__test_8c_ad1a464c4f0d92cf0ac994ecd7693bd10_icgraph}
\end{center}
\end{figure}


\index{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c@{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c}!main@{main}}
\index{main@{main}!s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c@{s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c}}
\subsubsection[{\texorpdfstring{main(int argc, char $\ast$$\ast$argv)}{main(int argc, char **argv)}}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{int}]{argc, }
\item[{char $\ast$$\ast$}]{argv}
\end{DoxyParamCaption}
)}\hypertarget{s2n__client__extensions__test_8c_a3c04138a5bfe5d72780bb7e82a18e627}{}\label{s2n__client__extensions__test_8c_a3c04138a5bfe5d72780bb7e82a18e627}


Definition at line 138 of file s2n\+\_\+client\+\_\+extensions\+\_\+test.\+c.


\begin{DoxyCode}
139 \{
140     \hyperlink{s2n__test_8h_abef58b8851265310b43e5b6d8c1d2ff5}{BEGIN\_TEST}();
141 
142     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(setenv(\textcolor{stringliteral}{"S2N\_ENABLE\_CLIENT\_MODE"}, \textcolor{stringliteral}{"1"}, 0));
143     \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(setenv(\textcolor{stringliteral}{"S2N\_DONT\_MLOCK"}, \textcolor{stringliteral}{"1"}, 0));
144 
145     \textcolor{comment}{/* Client doens't use the server name extension. */}
146     \{
147         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *client\_conn;
148         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *server\_conn;
149         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *server\_config;
150         \textcolor{keywordtype}{int} server\_to\_client[2];
151         \textcolor{keywordtype}{int} client\_to\_server[2];
152 
153         \textcolor{comment}{/* Create nonblocking pipes */}
154         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(server\_to\_client));
155         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(client\_to\_server));
156         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
157            \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(server\_to\_client[i], F\_SETFL, fcntl(server\_to\_client[i], 
      F\_GETFL) | O\_NONBLOCK), -1);
158            \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(client\_to\_server[i], F\_SETFL, fcntl(client\_to\_server[i], 
      F\_GETFL) | O\_NONBLOCK), -1);
159         \}
160 
161         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(client\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdbac93ba9ce574a0b5893fe2a5960e1785d}{S2N\_CLIENT}));
162         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(client\_conn, 
      server\_to\_client[0]));
163         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(client\_conn, 
      client\_to\_server[1]));
164 
165         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
166         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(server\_conn, 
      client\_to\_server[0]));
167         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(server\_conn, 
      server\_to\_client[1]));
168 
169         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
170         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a315153a7f97b2568970c19f7bf1d372e}{s2n\_config\_add\_cert\_chain\_and\_key}(
      server\_config, certificate, private\_key));
171         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(server\_conn, 
      server\_config));
172 
173         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_negotiate\_test\_server\_and\_client(server\_conn, client\_conn));
174 
175         \textcolor{comment}{/* Verify that the server didn't receive the server name. */}
176         \hyperlink{s2n__test_8h_a0dee18f231ad3035833af47c978d6930}{EXPECT\_NULL}(\hyperlink{s2n_8h_a541a5e22fc8b6295e4c6bb1692cdd850}{s2n\_get\_server\_name}(server\_conn));
177 
178         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_shutdown\_test\_server\_and\_client(server\_conn, client\_conn));
179 
180         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(server\_conn));
181         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(client\_conn));
182 
183         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(server\_config));
184 
185         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
186            \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(server\_to\_client[i]));
187            \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(client\_to\_server[i]));
188         \}
189     \}
190 
191     \textcolor{comment}{/* Client uses the server name extension. */}
192     \{
193         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *client\_conn;
194         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *server\_conn;
195         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *server\_config;
196         \textcolor{keywordtype}{int} server\_to\_client[2];
197         \textcolor{keywordtype}{int} client\_to\_server[2];
198 
199         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *sent\_server\_name = \textcolor{stringliteral}{"awesome.amazonaws.com"};
200         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *received\_server\_name;
201 
202         \textcolor{comment}{/* Create nonblocking pipes */}
203         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(server\_to\_client));
204         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(client\_to\_server));
205         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
206             \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(server\_to\_client[i], F\_SETFL, fcntl(server\_to\_client[i],
       F\_GETFL) | O\_NONBLOCK), -1);
207             \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(client\_to\_server[i], F\_SETFL, fcntl(client\_to\_server[i],
       F\_GETFL) | O\_NONBLOCK), -1);
208         \}
209 
210         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(client\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdbac93ba9ce574a0b5893fe2a5960e1785d}{S2N\_CLIENT}));
211         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(client\_conn, 
      server\_to\_client[0]));
212         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(client\_conn, 
      client\_to\_server[1]));
213 
214         \textcolor{comment}{/* Set the server name */}
215         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a9b37f3c0364e6de9f0b534e624204f62}{s2n\_set\_server\_name}(client\_conn, sent\_server\_name))
      ;
216 
217         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
218         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(server\_conn, 
      client\_to\_server[0]));
219         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(server\_conn, 
      server\_to\_client[1]));
220 
221         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
222         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a315153a7f97b2568970c19f7bf1d372e}{s2n\_config\_add\_cert\_chain\_and\_key}(
      server\_config, certificate, private\_key));
223         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(server\_conn, 
      server\_config));
224 
225         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_negotiate\_test\_server\_and\_client(server\_conn, client\_conn));
226 
227         \textcolor{comment}{/* Verify that the server name was received intact. */}
228         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(received\_server\_name = 
      \hyperlink{s2n_8h_a541a5e22fc8b6295e4c6bb1692cdd850}{s2n\_get\_server\_name}(server\_conn));
229         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(strlen(received\_server\_name), strlen(sent\_server\_name));
230         \hyperlink{s2n__test_8h_aad4c7abb254c4d6db9f9076687a2251c}{EXPECT\_BYTEARRAY\_EQUAL}(received\_server\_name, sent\_server\_name, strlen(
      received\_server\_name));
231 
232         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_shutdown\_test\_server\_and\_client(server\_conn, client\_conn));
233 
234         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(server\_conn));
235         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(client\_conn));
236 
237         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(server\_config));
238         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
239             \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(server\_to\_client[i]));
240             \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(client\_to\_server[i]));
241         \}
242     \}
243 
244     \textcolor{comment}{/* Client sends multiple server names. */}
245     \{
246         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *server\_conn;
247         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *server\_config;
248         \hyperlink{s2n_8h_af70ca0b089daa98cd79a424d3f6af15d}{s2n\_blocked\_status} server\_blocked;
249         \textcolor{keywordtype}{int} server\_to\_client[2];
250         \textcolor{keywordtype}{int} client\_to\_server[2];
251         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *sent\_server\_name = \textcolor{stringliteral}{"svr"};
252         \textcolor{keyword}{const} \textcolor{keywordtype}{char} *received\_server\_name;
253 
254         uint8\_t client\_extensions[] = \{
255             \textcolor{comment}{/* Extension type TLS\_EXTENSION\_SERVER\_NAME */}
256             0x00, 0x00,
257             \textcolor{comment}{/* Extension size */}
258             0x00, 0x0C,
259             \textcolor{comment}{/* All server names len */}
260             0x00, 0x0A,
261             \textcolor{comment}{/* First server name type - host name */}
262             0x00,
263             \textcolor{comment}{/* First server name len */}
264             0x00, 0x03,
265             \textcolor{comment}{/* First server name, matches sent\_server\_name */}
266             \textcolor{charliteral}{'s'}, \textcolor{charliteral}{'v'}, \textcolor{charliteral}{'r'},
267             \textcolor{comment}{/* Second server name type - host name */}
268             0x00,
269             \textcolor{comment}{/* Second server name len */}
270             0x00, 0x01,
271             \textcolor{comment}{/* Second server name */}
272             0xFF,
273         \};
274         \textcolor{keywordtype}{int} client\_extensions\_len = \textcolor{keyword}{sizeof}(client\_extensions);
275         uint8\_t client\_hello\_message[] = \{
276             \textcolor{comment}{/* Protocol version TLS 1.2 */}
277             0x03, 0x03,
278             \textcolor{comment}{/* Client random */}
279             \hyperlink{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{ZERO\_TO\_THIRTY\_ONE},
280             \textcolor{comment}{/* SessionID len - 32 bytes */}
281             0x20,
282             \textcolor{comment}{/* Session ID */}
283             \hyperlink{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{ZERO\_TO\_THIRTY\_ONE},
284             \textcolor{comment}{/* Cipher suites len */}
285             0x00, 0x02,
286             \textcolor{comment}{/* Cipher suite - TLS\_RSA\_WITH\_AES\_128\_CBC\_SHA256 */}
287             0x00, 0x3C,
288             \textcolor{comment}{/* Compression methods len */}
289             0x01,
290             \textcolor{comment}{/* Compression method - none */}
291             0x00,
292             \textcolor{comment}{/* Extensions len */}
293             (client\_extensions\_len >> 8) & 0xff, (client\_extensions\_len & 0xff),
294         \};
295         \textcolor{keywordtype}{int} body\_len = \textcolor{keyword}{sizeof}(client\_hello\_message) + client\_extensions\_len;
296         uint8\_t message\_header[] = \{
297             \textcolor{comment}{/* Handshake message type CLIENT HELLO */}
298             0x01,
299             \textcolor{comment}{/* Body len */}
300             (body\_len >> 16) & 0xff, (body\_len >> 8) & 0xff, (body\_len & 0xff),
301         \};
302         \textcolor{keywordtype}{int} message\_len = \textcolor{keyword}{sizeof}(message\_header) + body\_len;
303         uint8\_t record\_header[] = \{
304             \textcolor{comment}{/* Record type HANDSHAKE */}
305             0x16,
306             \textcolor{comment}{/* Protocol version TLS 1.2 */}
307             0x03, 0x03,
308             \textcolor{comment}{/* Message len */}
309             (message\_len >> 8) & 0xff, (message\_len & 0xff),
310         \};
311 
312         \textcolor{comment}{/* Create nonblocking pipes */}
313         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(server\_to\_client));
314         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(client\_to\_server));
315         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
316             \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(server\_to\_client[i], F\_SETFL, fcntl(server\_to\_client[i],
       F\_GETFL) | O\_NONBLOCK), -1);
317             \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(client\_to\_server[i], F\_SETFL, fcntl(client\_to\_server[i],
       F\_GETFL) | O\_NONBLOCK), -1);
318         \}
319 
320         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
321         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(server\_conn, 
      client\_to\_server[0]));
322         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(server\_conn, 
      server\_to\_client[1]));
323 
324         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
325         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a315153a7f97b2568970c19f7bf1d372e}{s2n\_config\_add\_cert\_chain\_and\_key}(
      server\_config, certificate, private\_key));
326         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(server\_conn, 
      server\_config));
327 
328         \textcolor{comment}{/* Send the client hello */}
329         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], record\_header, \textcolor{keyword}{sizeof}(record\_header)), \textcolor{keyword}{sizeof}(
      record\_header));
330         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], message\_header, \textcolor{keyword}{sizeof}(message\_header)), \textcolor{keyword}{sizeof}
      (message\_header));
331         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], client\_hello\_message, \textcolor{keyword}{sizeof}(
      client\_hello\_message)), \textcolor{keyword}{sizeof}(client\_hello\_message));
332         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], client\_extensions, \textcolor{keyword}{sizeof}(client\_extensions)), \textcolor{keyword}{
      sizeof}(client\_extensions));
333 
334         \textcolor{comment}{/* Verify that the CLIENT HELLO is accepted */}
335         \hyperlink{s2n_8h_a309d98d4c1adfd10c5dd62192f4c1051}{s2n\_negotiate}(server\_conn, &server\_blocked);
336         \hyperlink{s2n__test_8h_a6474fff07a0989c773c61761119a28ab}{EXPECT\_TRUE}(\hyperlink{s2n__client__extensions__test_8c_ad1a464c4f0d92cf0ac994ecd7693bd10}{s2n\_conn\_get\_current\_message\_type}(
      server\_conn) > \hyperlink{s2n__handshake_8h_a78b97fef55da786a15a849fd9d7e557ca0c8da6c451065bed79ea70684e6f3fca}{CLIENT\_HELLO});
337         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(server\_conn->\hyperlink{structs2n__connection_a902584c57c26269c7cbf42e4770ed356}{handshake}.\hyperlink{structs2n__handshake_a8b8974068a8f2c38a061ffb495a5ca1c}{handshake\_type}, FULL\_NO\_PFS)
      ;
338 
339         \textcolor{comment}{/* Verify that the server name was received intact. */}
340         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(received\_server\_name = 
      \hyperlink{s2n_8h_a541a5e22fc8b6295e4c6bb1692cdd850}{s2n\_get\_server\_name}(server\_conn));
341         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(strlen(received\_server\_name), strlen(sent\_server\_name));
342         \hyperlink{s2n__test_8h_aad4c7abb254c4d6db9f9076687a2251c}{EXPECT\_BYTEARRAY\_EQUAL}(received\_server\_name, sent\_server\_name, strlen(
      received\_server\_name));
343 
344         \textcolor{comment}{/* Not a real tls client but make sure we block on its close\_notify */}
345         \textcolor{keywordtype}{int} shutdown\_rc = \hyperlink{s2n_8h_a1cb034f97199a7f7d7888a447cf0fe67}{s2n\_shutdown}(server\_conn, &server\_blocked);
346         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(shutdown\_rc, -1);
347         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(\hyperlink{_mac_socket_8cpp_ad65a8842cc674e3ddf69355898c0ecbf}{errno}, EAGAIN);
348         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(server\_conn->\hyperlink{structs2n__connection_a1ba9fe08a4f37494def44e02d95a2ffa}{close\_notify\_queued}, 1);
349 
350         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(server\_conn));
351 
352         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(server\_config));
353         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
354             \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(server\_to\_client[i]));
355             \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(client\_to\_server[i]));
356         \}
357     \}
358 
359     \textcolor{comment}{/* Client sends a valid initial renegotiation\_info */}
360     \{
361         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *server\_conn;
362         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *server\_config;
363         \hyperlink{s2n_8h_af70ca0b089daa98cd79a424d3f6af15d}{s2n\_blocked\_status} server\_blocked;
364         \textcolor{keywordtype}{int} server\_to\_client[2];
365         \textcolor{keywordtype}{int} client\_to\_server[2];
366 
367         uint8\_t client\_extensions[] = \{
368             \textcolor{comment}{/* Extension type TLS\_EXTENSION\_RENEGOTIATION\_INFO */}
369             0xff, 0x01,
370             \textcolor{comment}{/* Extension size */}
371             0x00, 0x01,
372             \textcolor{comment}{/* Empty renegotiated\_connection */}
373             0x00,
374         \};
375         \textcolor{keywordtype}{int} client\_extensions\_len = \textcolor{keyword}{sizeof}(client\_extensions);
376         uint8\_t client\_hello\_message[] = \{
377             \textcolor{comment}{/* Protocol version TLS 1.2 */}
378             0x03, 0x03,
379             \textcolor{comment}{/* Client random */}
380             \hyperlink{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{ZERO\_TO\_THIRTY\_ONE},
381             \textcolor{comment}{/* SessionID len - 32 bytes */}
382             0x20,
383             \textcolor{comment}{/* Session ID */}
384             \hyperlink{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{ZERO\_TO\_THIRTY\_ONE},
385             \textcolor{comment}{/* Cipher suites len */}
386             0x00, 0x02,
387             \textcolor{comment}{/* Cipher suite - TLS\_RSA\_WITH\_AES\_128\_CBC\_SHA256 */}
388             0x00, 0x3C,
389             \textcolor{comment}{/* Compression methods len */}
390             0x01,
391             \textcolor{comment}{/* Compression method - none */}
392             0x00,
393             \textcolor{comment}{/* Extensions len */}
394             (client\_extensions\_len >> 8) & 0xff, (client\_extensions\_len & 0xff),
395         \};
396         \textcolor{keywordtype}{int} body\_len = \textcolor{keyword}{sizeof}(client\_hello\_message) + client\_extensions\_len;
397         uint8\_t message\_header[] = \{
398             \textcolor{comment}{/* Handshake message type CLIENT HELLO */}
399             0x01,
400             \textcolor{comment}{/* Body len */}
401             (body\_len >> 16) & 0xff, (body\_len >> 8) & 0xff, (body\_len & 0xff),
402         \};
403         \textcolor{keywordtype}{int} message\_len = \textcolor{keyword}{sizeof}(message\_header) + body\_len;
404         uint8\_t record\_header[] = \{
405             \textcolor{comment}{/* Record type HANDSHAKE */}
406             0x16,
407             \textcolor{comment}{/* Protocol version TLS 1.2 */}
408             0x03, 0x03,
409             \textcolor{comment}{/* Message len */}
410             (message\_len >> 8) & 0xff, (message\_len & 0xff),
411         \};
412 
413         \textcolor{comment}{/* Create nonblocking pipes */}
414         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(server\_to\_client));
415         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(client\_to\_server));
416         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
417             \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(server\_to\_client[i], F\_SETFL, fcntl(server\_to\_client[i],
       F\_GETFL) | O\_NONBLOCK), -1);
418             \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(client\_to\_server[i], F\_SETFL, fcntl(client\_to\_server[i],
       F\_GETFL) | O\_NONBLOCK), -1);
419         \}
420 
421         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
422         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(server\_conn, 
      client\_to\_server[0]));
423         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(server\_conn, 
      server\_to\_client[1]));
424 
425         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
426         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a315153a7f97b2568970c19f7bf1d372e}{s2n\_config\_add\_cert\_chain\_and\_key}(
      server\_config, certificate, private\_key));
427         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(server\_conn, 
      server\_config));
428 
429         \textcolor{comment}{/* Send the client hello */}
430         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], record\_header, \textcolor{keyword}{sizeof}(record\_header)), \textcolor{keyword}{sizeof}(
      record\_header));
431         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], message\_header, \textcolor{keyword}{sizeof}(message\_header)), \textcolor{keyword}{sizeof}
      (message\_header));
432         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], client\_hello\_message, \textcolor{keyword}{sizeof}(
      client\_hello\_message)), \textcolor{keyword}{sizeof}(client\_hello\_message));
433         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], client\_extensions, \textcolor{keyword}{sizeof}(client\_extensions)), \textcolor{keyword}{
      sizeof}(client\_extensions));
434 
435         \textcolor{comment}{/* Verify that the CLIENT HELLO is accepted */}
436         \hyperlink{s2n_8h_a309d98d4c1adfd10c5dd62192f4c1051}{s2n\_negotiate}(server\_conn, &server\_blocked);
437         \hyperlink{s2n__test_8h_a6474fff07a0989c773c61761119a28ab}{EXPECT\_TRUE}(\hyperlink{s2n__client__extensions__test_8c_ad1a464c4f0d92cf0ac994ecd7693bd10}{s2n\_conn\_get\_current\_message\_type}(
      server\_conn) > \hyperlink{s2n__handshake_8h_a78b97fef55da786a15a849fd9d7e557ca0c8da6c451065bed79ea70684e6f3fca}{CLIENT\_HELLO});
438         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(server\_conn->\hyperlink{structs2n__connection_a902584c57c26269c7cbf42e4770ed356}{handshake}.\hyperlink{structs2n__handshake_a8b8974068a8f2c38a061ffb495a5ca1c}{handshake\_type}, FULL\_NO\_PFS)
      ;
439 
440         \textcolor{comment}{/* Verify that the that we detected secure\_renegotiation */}
441         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(server\_conn->\hyperlink{structs2n__connection_a579beb899db6aa0c25366672938b2216}{secure\_renegotiation}, 1);
442 
443         \textcolor{comment}{/* Not a real tls client but make sure we block on its close\_notify */}
444         \textcolor{keywordtype}{int} shutdown\_rc = \hyperlink{s2n_8h_a1cb034f97199a7f7d7888a447cf0fe67}{s2n\_shutdown}(server\_conn, &server\_blocked);
445         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(shutdown\_rc, -1);
446         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(\hyperlink{_mac_socket_8cpp_ad65a8842cc674e3ddf69355898c0ecbf}{errno}, EAGAIN);
447         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(server\_conn->\hyperlink{structs2n__connection_a1ba9fe08a4f37494def44e02d95a2ffa}{close\_notify\_queued}, 1);
448 
449         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(server\_conn));
450 
451         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(server\_config));
452         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
453             \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(server\_to\_client[i]));
454             \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(client\_to\_server[i]));
455         \}
456     \}
457 
458     \textcolor{comment}{/* Client sends a non-empty initial renegotiation\_info */}
459     \{
460         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *server\_conn;
461         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *server\_config;
462         \hyperlink{s2n_8h_af70ca0b089daa98cd79a424d3f6af15d}{s2n\_blocked\_status} server\_blocked;
463         \textcolor{keywordtype}{int} server\_to\_client[2];
464         \textcolor{keywordtype}{int} client\_to\_server[2];
465 
466         uint8\_t client\_extensions[] = \{
467             \textcolor{comment}{/* Extension type TLS\_EXTENSION\_RENEGOTIATION\_INFO */}
468             0xff, 0x01,
469             \textcolor{comment}{/* Extension size */}
470             0x00, 0x21,
471             \textcolor{comment}{/* renegotiated\_connection len */}
472             0x20,
473             \textcolor{comment}{/* fake enegotiated\_connection */}
474             \hyperlink{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{ZERO\_TO\_THIRTY\_ONE},
475         \};
476         \textcolor{keywordtype}{int} client\_extensions\_len = \textcolor{keyword}{sizeof}(client\_extensions);
477         uint8\_t client\_hello\_message[] = \{
478             \textcolor{comment}{/* Protocol version TLS 1.2 */}
479             0x03, 0x03,
480             \textcolor{comment}{/* Client random */}
481             \hyperlink{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{ZERO\_TO\_THIRTY\_ONE},
482             \textcolor{comment}{/* SessionID len - 32 bytes */}
483             0x20,
484             \textcolor{comment}{/* Session ID */}
485             \hyperlink{s2n__client__extensions__test_8c_ac56686e866d4e21e0b112979b16cd453}{ZERO\_TO\_THIRTY\_ONE},
486             \textcolor{comment}{/* Cipher suites len */}
487             0x00, 0x02,
488             \textcolor{comment}{/* Cipher suite - TLS\_RSA\_WITH\_AES\_128\_CBC\_SHA256 */}
489             0x00, 0x3C,
490             \textcolor{comment}{/* Compression methods len */}
491             0x01,
492             \textcolor{comment}{/* Compression method - none */}
493             0x00,
494             \textcolor{comment}{/* Extensions len */}
495             (client\_extensions\_len >> 8) & 0xff, (client\_extensions\_len & 0xff),
496         \};
497         \textcolor{keywordtype}{int} body\_len = \textcolor{keyword}{sizeof}(client\_hello\_message) + client\_extensions\_len;
498         uint8\_t message\_header[] = \{
499             \textcolor{comment}{/* Handshake message type CLIENT HELLO */}
500             0x01,
501             \textcolor{comment}{/* Body len */}
502             (body\_len >> 16) & 0xff, (body\_len >> 8) & 0xff, (body\_len & 0xff),
503         \};
504         \textcolor{keywordtype}{int} message\_len = \textcolor{keyword}{sizeof}(message\_header) + body\_len;
505         uint8\_t record\_header[] = \{
506             \textcolor{comment}{/* Record type HANDSHAKE */}
507             0x16,
508             \textcolor{comment}{/* Protocol version TLS 1.2 */}
509             0x03, 0x03,
510             \textcolor{comment}{/* Message len */}
511             (message\_len >> 8) & 0xff, (message\_len & 0xff),
512         \};
513 
514         \textcolor{comment}{/* Create nonblocking pipes */}
515         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(server\_to\_client));
516         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(client\_to\_server));
517         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
518             \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(server\_to\_client[i], F\_SETFL, fcntl(server\_to\_client[i],
       F\_GETFL) | O\_NONBLOCK), -1);
519             \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(client\_to\_server[i], F\_SETFL, fcntl(client\_to\_server[i],
       F\_GETFL) | O\_NONBLOCK), -1);
520         \}
521 
522         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
523         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(server\_conn, 
      client\_to\_server[0]));
524         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(server\_conn, 
      server\_to\_client[1]));
525 
526         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
527         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a315153a7f97b2568970c19f7bf1d372e}{s2n\_config\_add\_cert\_chain\_and\_key}(
      server\_config, certificate, private\_key));
528         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(server\_conn, 
      server\_config));
529 
530         \textcolor{comment}{/* Send the client hello */}
531         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], record\_header, \textcolor{keyword}{sizeof}(record\_header)), \textcolor{keyword}{sizeof}(
      record\_header));
532         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], message\_header, \textcolor{keyword}{sizeof}(message\_header)), \textcolor{keyword}{sizeof}
      (message\_header));
533         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], client\_hello\_message, \textcolor{keyword}{sizeof}(
      client\_hello\_message)), \textcolor{keyword}{sizeof}(client\_hello\_message));
534         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(write(client\_to\_server[1], client\_extensions, \textcolor{keyword}{sizeof}(client\_extensions)), \textcolor{keyword}{
      sizeof}(client\_extensions));
535 
536         \textcolor{comment}{/* Verify that we fail for non-empty renegotiated\_connection */}
537         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a7b2423a701b89f7ca3a4de550c519d35}{s2n\_connection\_set\_blinding}(server\_conn, 
      \hyperlink{s2n_8h_a364ad496c9dd42fd3117a2f9d3289e62a1b0ee228485be6bb2d6e2129827d51d2}{S2N\_SELF\_SERVICE\_BLINDING}));
538         \hyperlink{s2n_8h_a309d98d4c1adfd10c5dd62192f4c1051}{s2n\_negotiate}(server\_conn, &server\_blocked);
539         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(\hyperlink{s2n_8h_a40090b57614b9677d4cbcdd3c3276e7d}{s2n\_errno}, 
      \hyperlink{s2n__errno_8h_a64ed9ec59a957387654c5e5865325374a76a4357301ed1dc1f8cc850d5eed881d}{S2N\_ERR\_NON\_EMPTY\_RENEGOTIATION\_INFO});
540 
541         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(server\_conn));
542 
543         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(server\_config));
544         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
545             \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(server\_to\_client[i]));
546             \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(client\_to\_server[i]));
547         \}
548     \}
549 
550     \textcolor{comment}{/* Client doesn't use the OCSP extension. */}
551     \{
552         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *client\_conn;
553         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *server\_conn;
554         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *server\_config;
555         \textcolor{keywordtype}{int} server\_to\_client[2];
556         \textcolor{keywordtype}{int} client\_to\_server[2];
557         uint32\_t \hyperlink{crypto_2asn1_2asn1_8h_a5a2d57a92488e64c730cabc247c9d5b5}{length};
558 
559         \textcolor{comment}{/* Create nonblocking pipes */}
560         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(server\_to\_client));
561         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(client\_to\_server));
562         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
563            \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(server\_to\_client[i], F\_SETFL, fcntl(server\_to\_client[i], 
      F\_GETFL) | O\_NONBLOCK), -1);
564            \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(client\_to\_server[i], F\_SETFL, fcntl(client\_to\_server[i], 
      F\_GETFL) | O\_NONBLOCK), -1);
565         \}
566 
567         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(client\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdbac93ba9ce574a0b5893fe2a5960e1785d}{S2N\_CLIENT}));
568         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(client\_conn, 
      server\_to\_client[0]));
569         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(client\_conn, 
      client\_to\_server[1]));
570 
571         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
572         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(server\_conn, 
      client\_to\_server[0]));
573         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(server\_conn, 
      server\_to\_client[1]));
574 
575         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
576         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(
      \hyperlink{s2n_8h_a0275e457e9c62cf1d5b9a1126e853003}{s2n\_config\_add\_cert\_chain\_and\_key\_with\_status}(server\_config, 
      certificate, private\_key, server\_ocsp\_status, \textcolor{keyword}{sizeof}(server\_ocsp\_status)));
577         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(server\_conn, 
      server\_config));
578 
579         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_negotiate\_test\_server\_and\_client(server\_conn, client\_conn));
580 
581         \textcolor{comment}{/* Verify that the client didn't receive an OCSP response. */}
582         \hyperlink{s2n__test_8h_a0dee18f231ad3035833af47c978d6930}{EXPECT\_NULL}(\hyperlink{s2n_8h_a2b18cd3437636a7a21e10f3d5d09ff9d}{s2n\_connection\_get\_ocsp\_response}(client\_conn
      , &length));
583         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(length, 0);
584 
585         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_shutdown\_test\_server\_and\_client(server\_conn, client\_conn));
586 
587         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(server\_conn));
588         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(client\_conn));
589 
590         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(server\_config));
591 
592         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
593            \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(server\_to\_client[i]));
594            \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(client\_to\_server[i]));
595         \}
596     \}
597 
598     \textcolor{comment}{/* Server doesn't support the OCSP extension. */}
599     \{
600         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *client\_conn;
601         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *server\_conn;
602         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *server\_config;
603         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *client\_config;
604         \textcolor{keywordtype}{int} server\_to\_client[2];
605         \textcolor{keywordtype}{int} client\_to\_server[2];
606         uint32\_t \hyperlink{crypto_2asn1_2asn1_8h_a5a2d57a92488e64c730cabc247c9d5b5}{length};
607 
608         \textcolor{comment}{/* Create nonblocking pipes */}
609         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(server\_to\_client));
610         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(client\_to\_server));
611         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
612            \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(server\_to\_client[i], F\_SETFL, fcntl(server\_to\_client[i], 
      F\_GETFL) | O\_NONBLOCK), -1);
613            \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(client\_to\_server[i], F\_SETFL, fcntl(client\_to\_server[i], 
      F\_GETFL) | O\_NONBLOCK), -1);
614         \}
615 
616         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(client\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdbac93ba9ce574a0b5893fe2a5960e1785d}{S2N\_CLIENT}));
617         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(client\_conn, 
      server\_to\_client[0]));
618         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(client\_conn, 
      client\_to\_server[1]));
619 
620         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(client\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
621         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ae98f2b06b3311e7e845e938392d3505d}{s2n\_config\_set\_status\_request\_type}(
      client\_config, \hyperlink{s2n_8h_a7d38e45340d223d0100a2d4bc0526635a3e83f0e90eef54adc21b3d97a9a0d9b8}{S2N\_STATUS\_REQUEST\_OCSP}));
622         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(client\_conn, 
      client\_config));
623 
624         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
625         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(server\_conn, 
      client\_to\_server[0]));
626         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(server\_conn, 
      server\_to\_client[1]));
627 
628         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
629         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a315153a7f97b2568970c19f7bf1d372e}{s2n\_config\_add\_cert\_chain\_and\_key}(
      server\_config, certificate, private\_key));
630         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(server\_conn, 
      server\_config));
631 
632         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_negotiate\_test\_server\_and\_client(server\_conn, client\_conn));
633 
634         \textcolor{comment}{/* Verify that the client didn't receive an OCSP response. */}
635         \hyperlink{s2n__test_8h_a0dee18f231ad3035833af47c978d6930}{EXPECT\_NULL}(\hyperlink{s2n_8h_a2b18cd3437636a7a21e10f3d5d09ff9d}{s2n\_connection\_get\_ocsp\_response}(client\_conn
      , &length));
636         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(length, 0);
637 
638         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_shutdown\_test\_server\_and\_client(server\_conn, client\_conn));
639 
640         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(server\_conn));
641         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(client\_conn));
642 
643         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(server\_config));
644         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(client\_config));
645 
646         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
647            \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(server\_to\_client[i]));
648            \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(client\_to\_server[i]));
649         \}
650     \}
651 
652     \textcolor{comment}{/* Server and client support the OCSP extension. */}
653     \{
654         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *client\_conn;
655         \textcolor{keyword}{struct }\hyperlink{structs2n__connection}{s2n\_connection} *server\_conn;
656         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *server\_config;
657         \textcolor{keyword}{struct }\hyperlink{structs2n__config}{s2n\_config} *client\_config;
658         \textcolor{keywordtype}{int} server\_to\_client[2];
659         \textcolor{keywordtype}{int} client\_to\_server[2];
660         uint32\_t \hyperlink{crypto_2asn1_2asn1_8h_a5a2d57a92488e64c730cabc247c9d5b5}{length};
661 
662         \textcolor{comment}{/* Create nonblocking pipes */}
663         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(server\_to\_client));
664         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(pipe(client\_to\_server));
665         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
666            \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(server\_to\_client[i], F\_SETFL, fcntl(server\_to\_client[i], 
      F\_GETFL) | O\_NONBLOCK), -1);
667            \hyperlink{s2n__test_8h_ab2e8a76bb5b142d6279d1e449dbefdc7}{EXPECT\_NOT\_EQUAL}(fcntl(client\_to\_server[i], F\_SETFL, fcntl(client\_to\_server[i], 
      F\_GETFL) | O\_NONBLOCK), -1);
668         \}
669 
670         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(client\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdbac93ba9ce574a0b5893fe2a5960e1785d}{S2N\_CLIENT}));
671         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(client\_conn, 
      server\_to\_client[0]));
672         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(client\_conn, 
      client\_to\_server[1]));
673 
674         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(client\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
675         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ae98f2b06b3311e7e845e938392d3505d}{s2n\_config\_set\_status\_request\_type}(
      client\_config, \hyperlink{s2n_8h_a7d38e45340d223d0100a2d4bc0526635a3e83f0e90eef54adc21b3d97a9a0d9b8}{S2N\_STATUS\_REQUEST\_OCSP}));
676         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(client\_conn, 
      client\_config));
677 
678         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_conn = \hyperlink{s2n_8h_acffb3a7098380db63bc23498482ee4b9}{s2n\_connection\_new}(
      \hyperlink{s2n_8h_a77a64e3b657f90d221c5faf99c643cdba6d8d11a87ee62316e49b1b166c2b2c52}{S2N\_SERVER}));
679         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a098af174491e2fe62cb0635d1adab854}{s2n\_connection\_set\_read\_fd}(server\_conn, 
      client\_to\_server[0]));
680         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_ab340fbb2459b04d8f6d2803483a14ab1}{s2n\_connection\_set\_write\_fd}(server\_conn, 
      server\_to\_client[1]));
681 
682         \hyperlink{s2n__test_8h_a555ed2148eff1d467ef9ec5eac91bdc2}{EXPECT\_NOT\_NULL}(server\_config = \hyperlink{s2n_8h_a29ce06d12862218a283abdac554c8e19}{s2n\_config\_new}());
683         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(
      \hyperlink{s2n_8h_a0275e457e9c62cf1d5b9a1126e853003}{s2n\_config\_add\_cert\_chain\_and\_key\_with\_status}(server\_config, 
      certificate, private\_key, server\_ocsp\_status, \textcolor{keyword}{sizeof}(server\_ocsp\_status)));
684         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a85ced5d91831da552d5c4997a3f30abb}{s2n\_connection\_set\_config}(server\_conn, 
      server\_config));
685 
686         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_negotiate\_test\_server\_and\_client(server\_conn, client\_conn));
687 
688         \textcolor{comment}{/* Verify that the client didn't receive an OCSP response. */}
689         \hyperlink{s2n__test_8h_a0dee18f231ad3035833af47c978d6930}{EXPECT\_NULL}(\hyperlink{s2n_8h_a2b18cd3437636a7a21e10f3d5d09ff9d}{s2n\_connection\_get\_ocsp\_response}(client\_conn
      , &length));
690         \hyperlink{s2n__test_8h_aea4dfdd3a9d6afc7bbb40248a8437774}{EXPECT\_EQUAL}(length, 0);
691 
692         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(s2n\_shutdown\_test\_server\_and\_client(server\_conn, client\_conn));
693 
694         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(server\_conn));
695         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a03ed084d7fb943c7d32b13075ed8eff7}{s2n\_connection\_free}(client\_conn));
696 
697         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(server\_config));
698         \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(\hyperlink{s2n_8h_a25b7d82e94f572b657be3936196222c3}{s2n\_config\_free}(client\_config));
699 
700         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
701            \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(server\_to\_client[i]));
702            \hyperlink{s2n__test_8h_ad26d98d36bb5f8a59a90fe3a16d0297e}{EXPECT\_SUCCESS}(close(client\_to\_server[i]));
703         \}
704     \}
705 
706     \hyperlink{s2n__test_8h_a45a83f30c32ca6265c28a1bef6dbe046}{END\_TEST}();
707     \textcolor{keywordflow}{return} 0;
708 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{s2n__client__extensions__test_8c_a3c04138a5bfe5d72780bb7e82a18e627_cgraph}
\end{center}
\end{figure}


